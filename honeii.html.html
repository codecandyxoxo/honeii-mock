<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>honeii - Complete Admin Panel</title>
    
    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react.development.js"></script>
    
    <style>
        /* ==================== */
        /* DO-NOT-TOUCH: BOOT STYLES */
        /* ==================== */
        :root {
            --brand: #3b82f6;
            --brand-light: #60a5fa;
            --brand-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --surface: #ffffff;
            --surface-secondary: #f8fafc;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-secondary: #64748b;
            --honeycomb-bg: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f1f5f9' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f1f5f9;
            color: var(--text);
            min-height: 100vh;
        }
        
        .ui-loaded {
            position: fixed;
            top: 10px;
            left: 10px;
            background: var(--success);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            z-index: 9999;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(239, 68, 68, 0.95);
            color: white;
            z-index: 10000;
            padding: 40px;
            overflow: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        /* ==================== */
        /* DO-NOT-TOUCH: EXISTING LAYOUT */
        /* ==================== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
        }
        
        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ==================== */
        /* ENHANCED ADMIN STYLES */
        /* ==================== */
        .admin-sidebar {
            background: #1e293b;
            color: white;
        }
        
        .tenant-sidebar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
        }
        
        .company-sidebar {
            background: #0f172a;
            color: white;
        }
        
        .admin-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: #cbd5e1;
            text-decoration: none;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .admin-nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .admin-nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: var(--brand);
        }
        
        .admin-nav-section {
            padding: 16px 24px;
            font-size: 12px;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sidebar-header {
            padding: 24px 16px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 16px;
        }
        
        /* ==================== */
        /* ADMIN COMPONENTS */
        /* ==================== */
        .admin-panel {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .admin-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
        }
        
        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .admin-section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }
        
        .admin-section-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }
        
        .kpi-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--brand);
            margin: 8px 0;
        }
        
        .kpi-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .kpi-trend {
            font-size: 12px;
            color: var(--success);
            margin-top: 8px;
        }
        
        /* Tables */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        
        .admin-table th {
            text-align: left;
            padding: 12px 16px;
            background: var(--surface-secondary);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }
        
        .admin-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            font-size: 14px;
        }
        
        .admin-table tr:hover {
            background: var(--surface-secondary);
        }
        
        /* Form Elements */
        .admin-form-group {
            margin-bottom: 20px;
        }
        
        .admin-form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }
        
        .admin-form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .admin-form-input:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Toggle Switches */
        .admin-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .admin-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .admin-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }
        
        .admin-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .admin-toggle-slider {
            background-color: var(--success);
        }
        
        input:checked + .admin-toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Badges */
        .admin-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-error { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-neutral { background: #f3f4f6; color: #6b7280; }
        
        /* Action Buttons */
        .admin-actions {
            display: flex;
            gap: 8px;
        }
        
        .admin-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .admin-btn-primary {
            background: var(--brand);
            color: white;
        }
        
        .admin-btn-primary:hover {
            background: var(--brand-dark);
        }
        
        .admin-btn-secondary {
            background: var(--surface-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .admin-btn-secondary:hover {
            background: #f1f5f9;
        }
        
        /* Modal */
        .admin-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        
        .admin-modal {
            background: var(--surface);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        /* Charts */
        .admin-chart {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }
        
        /* Payment Status */
        .payment-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-captured { background: #dbeafe; color: #1e40af; }
        .status-disputed { background: #fee2e2; color: #991b1b; }
        .status-refunded { background: #f3f4f6; color: #6b7280; }
        
        /* ==================== */
        /* DO-NOT-TOUCH: EXISTING UTILITIES */
        /* ==================== */
        .mt-4 { margin-top: 16px; }
        .mt-8 { margin-top: 32px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-8 { margin-bottom: 32px; }
        .gap-4 { gap: 16px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-secondary { color: var(--text-secondary); font-size: 14px; }
        
        /* Blueprint Card */
        .blueprint-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: var(--surface);
            transition: all 0.2s;
        }
        
        .blueprint-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .blueprint-content {
            padding: 20px;
        }
        
        .blueprint-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 24px;
            color: var(--text-secondary);
            font-size: 14px;
            border-top: 1px solid var(--border);
            margin-top: 32px;
        }
    </style>
</head>
<body>
    <div class="ui-loaded">honeii Admin Panel âœ… React 18.2.0</div>
    <div id="root"></div>

    <script>
        // ==========================================================
        // DO-NOT-TOUCH: BOOT LOGIC
        // ==========================================================
        const e = React.createElement;
        
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            
            componentDidCatch(error, errorInfo) {
                console.error('Error:', error, errorInfo);
            }
            
            render() {
                if (this.state.hasError) {
                    return e('div', { className: 'error-overlay' }, [
                        e('h1', { key: 'title', style: { marginBottom: '20px', fontSize: '24px' } }, 'Runtime Error'),
                        e('pre', { key: 'error', style: { whiteSpace: 'pre-wrap', fontFamily: 'monospace' } }, 
                            this.state.error.toString()
                        ),
                        e('button', {
                            key: 'reload',
                            onClick: () => window.location.reload(),
                            className: 'admin-btn admin-btn-primary',
                            style: { marginTop: '20px' }
                        }, 'Reload Application')
                    ]);
                }
                return this.props.children;
            }
        }

        // ==========================================================
        // DO-NOT-TOUCH PAYMENT CONTRACT (LOCKED)
        // ==========================================================
        const PAYMENT_CONTRACT = {
            VERSION: '2.0.0',
            
            METHODS: {
                WALLET: 'wallet',
                CARD: 'card'
            },
            
            STATUSES: {
                // Activation statuses
                DRAFT: 'draft',
                LAUNCHED: 'launched',
                PENDING_CARD: 'pending_card',
                CAPTURED: 'captured',
                DISPUTED: 'disputed',
                KILLED: 'killed',
                REFUNDED: 'refunded',
                PAUSED: 'paused'
            },
            
            RULES: {
                // Wallet: Pay in full, launch instantly
                WALLET_INSTANT: true,
                WALLET_FULL_CAPTURE: true,
                
                // Card: Hard reserve, delayed launch
                CARD_HARD_RESERVE: true,
                CARD_DELAYED_LAUNCH: true,
                CARD_VERIFICATION_DELAY_MS: 10000, // 10 seconds default
                
                // Dispute auto-kill
                DISPUTE_AUTO_KILL: true,
                DISPUTE_AUTO_FREEZE: true,
                
                // Refund destinations
                DEFAULT_CARD_REFUND: 'gift_card',
                REFUND_DESTINATIONS: ['card', 'gift_card', 'wallet']
            },
            
            MESSAGES: {
                WALLET: 'Pay in full from wallet. Launches instantly.',
                CARD: 'Pay in full from card. Launches after verification (typically 24-48h).',
                DISPUTE: 'Disputes automatically pause spending and freeze card payments.'
            }
        };

        // ==========================================================
        // ENHANCED MOCK DATABASE (EXTENDED)
        // ==========================================================
        const EnhancedMockDB = {
            load: () => {
                try {
                    const saved = localStorage.getItem('honeii_enhanced_db');
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) {
                    console.warn('Failed to load enhanced DB:', e);
                }
                
                // Default enhanced data structure
                const defaultPaymentSettings = {
                    cardDelayedLaunch: true,
                    cardDelaySeconds: 10,
                    hardReserveEnabled: true,
                    walletInstantLaunch: true,
                    killSwitchOnDispute: true,
                    defaultCardRefund: 'gift_card',
                    cardPaymentsEnabled: true,
                    googleChannelEnabled: true,
                    mailBucketsEnabled: true,
                    discountsEnabled: true
                };
                
                const defaultDiscountSettings = {
                    enabled: true,
                    options: [
                        { id: '12.5', label: '12.5% Off', value: 12.5 },
                        { id: '25', label: '25% Off', value: 25 }
                    ],
                    fastStartSplit: 0.5
                };
                
                return {
                    // Core collections
                    blueprints: [
                        {
                            id: 'bp_001',
                            version: 1,
                            title: 'Summer Detox Challenge',
                            description: '21-day organic cleanse program with proven results',
                            objective: 'lead_gen',
                            channels: ['meta'],
                            dailyMin: 10,
                            dailyMax: 500,
                            durationMin: 7,
                            durationMax: 30,
                            presets: [
                                { id: 'conservative', daily: 25, duration: 14 },
                                { id: 'balanced', daily: 50, duration: 21 },
                                { id: 'aggressive', daily: 100, duration: 30 }
                            ],
                            creatives: ['https://picsum.photos/seed/detox/600/400'],
                            headline: 'Transform Your Health in 21 Days',
                            body: 'Join thousands who have completed our proven detox program.',
                            cta: 'Start Challenge',
                            targeting: 'Health-conscious adults 25-55',
                            destination: 'https://example.com/detox',
                            utm: '?utm_source=honeii&utm_medium=cpc&utm_campaign=detox',
                            status: 'published',
                            requiresApproval: false,
                            createdAt: '2024-01-15T10:00:00Z',
                            updatedAt: '2024-01-15T10:00:00Z',
                            healthCheck: {
                                lastCheck: '2024-01-15T10:00:00Z',
                                compliance: 'pass',
                                clarity: 85,
                                cta: 90,
                                suggestions: ['Consider adding testimonials']
                            },
                            tenantId: 'tenant_001'
                        }
                    ],
                    
                    activations: [],
                    
                    // Enhanced collections
                    disputes: [],
                    auditLog: [
                        {
                            id: 'audit_001',
                            timestamp: '2024-01-15T10:00:00Z',
                            actor: 'system',
                            action: 'system_initialized',
                            entity: 'system',
                            entityId: 'system',
                            summary: 'System initialized with default data',
                            tenantId: null
                        }
                    ],
                    
                    mailBuckets: [
                        {
                            id: 'bucket_001',
                            name: 'Active Distributors',
                            description: 'Distributors with active campaigns',
                            tags: ['distributors', 'active'],
                            contacts: 125,
                            sent: 342,
                            delivered: 335,
                            opened: 287,
                            tenantId: 'tenant_001'
                        }
                    ],
                    
                    users: [
                        {
                            id: 'user_001',
                            name: 'Sarah Jenkins',
                            email: 'sarah@example.com',
                            role: 'honeii_admin',
                            tenantId: null,
                            country: 'US',
                            currency: 'USD',
                            walletBalance: 1200,
                            paymentFrozen: false,
                            discountEligible: true,
                            riskLevel: 'low',
                            createdAt: '2024-01-01T00:00:00Z'
                        },
                        {
                            id: 'user_002',
                            name: 'Alex Chen',
                            email: 'alex@example.com',
                            role: 'company_admin',
                            tenantId: 'tenant_001',
                            country: 'CA',
                            currency: 'CAD',
                            walletBalance: 850,
                            paymentFrozen: true,
                            discountEligible: false,
                            riskLevel: 'high',
                            createdAt: '2024-01-05T00:00:00Z'
                        },
                        {
                            id: 'user_003',
                            name: 'Distributor User',
                            email: 'distributor@example.com',
                            role: 'distributor',
                            tenantId: 'tenant_001',
                            country: 'US',
                            currency: 'USD',
                            walletBalance: 500,
                            paymentFrozen: false,
                            discountEligible: true,
                            riskLevel: 'medium',
                            createdAt: '2024-01-10T00:00:00Z'
                        }
                    ],
                    
                    tenants: [
                        {
                            id: 'tenant_001',
                            name: 'Acme Corporation',
                            status: 'active',
                            users: 5,
                            campaigns: 12,
                            monthlySpend: 2500,
                            plan: 'enterprise'
                        },
                        {
                            id: 'tenant_002',
                            name: 'Global Wellness',
                            status: 'active',
                            users: 3,
                            campaigns: 8,
                            monthlySpend: 1800,
                            plan: 'pro'
                        }
                    ],
                    
                    // FIX PACK 1: Per-tenant configuration
                    paymentSettingsByTenant: [
                        { tenantId: 'tenant_001', ...defaultPaymentSettings },
                        { tenantId: 'tenant_002', ...defaultPaymentSettings }
                    ],
                    
                    discountSettingsByTenant: [
                        { tenantId: 'tenant_001', ...defaultDiscountSettings },
                        { tenantId: 'tenant_002', ...defaultDiscountSettings }
                    ],
                    
                    tenantSettings: [
                        {
                            tenantId: 'tenant_001',
                            brandName: 'Acme Corp',
                            primaryColor: '#3b82f6',
                            secondaryColor: '#f59e0b',
                            honeycombBackground: true,
                            logoUrl: '',
                            fxRates: {
                                USD: 1,
                                CAD: 1.35,
                                EUR: 0.92,
                                GBP: 0.79
                            },
                            roundingRule: 'ceil',
                            featureFlags: {
                                googleChannel: true,
                                mailBuckets: true,
                                discounts: true,
                                cardPayments: true,
                                disputeAutoFreeze: true
                            }
                        },
                        {
                            tenantId: 'tenant_002',
                            brandName: 'Global Wellness',
                            primaryColor: '#10b981',
                            secondaryColor: '#8b5cf6',
                            honeycombBackground: false,
                            logoUrl: '',
                            fxRates: {
                                USD: 1,
                                CAD: 1.35,
                                EUR: 0.92,
                                GBP: 0.79
                            },
                            roundingRule: 'floor',
                            featureFlags: {
                                googleChannel: true,
                                mailBuckets: false,
                                discounts: false,
                                cardPayments: true,
                                disputeAutoFreeze: false
                            }
                        }
                    ],
                    
                    ledger: []
                };
            },
            
            save: (data) => {
                try {
                    localStorage.setItem('honeii_enhanced_db', JSON.stringify(data));
                } catch (e) {
                    console.warn('Failed to save enhanced DB:', e);
                }
            },
            
            update: (updates) => {
                const data = EnhancedMockDB.load();
                Object.assign(data, updates);
                EnhancedMockDB.save(data);
                return data;
            },
            
            // ==================== FIX PACK 1: PER-TENANT HELPERS ====================
            
            getPaymentSettings: (tenantId) => {
                const data = EnhancedMockDB.load();
                const settings = data.paymentSettingsByTenant.find(ps => ps.tenantId === tenantId);
                if (!settings) {
                    // Create default if missing
                    const defaultSettings = {
                        cardDelayedLaunch: true,
                        cardDelaySeconds: 10,
                        hardReserveEnabled: true,
                        walletInstantLaunch: true,
                        killSwitchOnDispute: true,
                        defaultCardRefund: 'gift_card',
                        cardPaymentsEnabled: true,
                        googleChannelEnabled: true,
                        mailBucketsEnabled: true,
                        discountsEnabled: true,
                        tenantId: tenantId
                    };
                    data.paymentSettingsByTenant.push(defaultSettings);
                    EnhancedMockDB.save(data);
                    return defaultSettings;
                }
                return settings;
            },
            
            setPaymentSettings: (tenantId, patch) => {
                const data = EnhancedMockDB.load();
                let index = data.paymentSettingsByTenant.findIndex(ps => ps.tenantId === tenantId);
                if (index === -1) {
                    data.paymentSettingsByTenant.push({ tenantId, ...patch });
                } else {
                    data.paymentSettingsByTenant[index] = { ...data.paymentSettingsByTenant[index], ...patch };
                }
                EnhancedMockDB.save(data);
                return data.paymentSettingsByTenant[index];
            },
            
            getDiscountSettings: (tenantId) => {
                const data = EnhancedMockDB.load();
                const settings = data.discountSettingsByTenant.find(ds => ds.tenantId === tenantId);
                if (!settings) {
                    // Create default if missing
                    const defaultSettings = {
                        enabled: true,
                        options: [
                            { id: '12.5', label: '12.5% Off', value: 12.5 },
                            { id: '25', label: '25% Off', value: 25 }
                        ],
                        fastStartSplit: 0.5,
                        tenantId: tenantId
                    };
                    data.discountSettingsByTenant.push(defaultSettings);
                    EnhancedMockDB.save(data);
                    return defaultSettings;
                }
                return settings;
            },
            
            setDiscountSettings: (tenantId, patch) => {
                const data = EnhancedMockDB.load();
                let index = data.discountSettingsByTenant.findIndex(ds => ds.tenantId === tenantId);
                if (index === -1) {
                    data.discountSettingsByTenant.push({ tenantId, ...patch });
                } else {
                    data.discountSettingsByTenant[index] = { ...data.discountSettingsByTenant[index], ...patch };
                }
                EnhancedMockDB.save(data);
                return data.discountSettingsByTenant[index];
            },
            
            // ==================== ENHANCED METHODS ====================
            
            // Blueprint Management
            createBlueprint: (blueprintData) => {
                const data = EnhancedMockDB.load();
                
                // FIX PACK 1: Enforce tenantId presence
                if (!blueprintData.tenantId) {
                    console.error('Blueprint creation requires tenantId');
                    return null;
                }
                
                const blueprint = {
                    ...blueprintData,
                    id: `bp_${Date.now()}`,
                    version: 1,
                    status: 'draft',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                data.blueprints.push(blueprint);
                EnhancedMockDB.addAuditLog('blueprint.create', blueprint.id, blueprint.title, blueprintData.tenantId);
                EnhancedMockDB.save(data);
                return blueprint;
            },
            
            updateBlueprint: (blueprintId, updates) => {
                const data = EnhancedMockDB.load();
                const index = data.blueprints.findIndex(bp => bp.id === blueprintId);
                if (index !== -1) {
                    const oldVersion = data.blueprints[index].version;
                    data.blueprints[index] = {
                        ...data.blueprints[index],
                        ...updates,
                        version: oldVersion + 1,
                        updatedAt: new Date().toISOString()
                    };
                    EnhancedMockDB.addAuditLog('blueprint.update', blueprintId, data.blueprints[index].title, data.blueprints[index].tenantId);
                    EnhancedMockDB.save(data);
                    return data.blueprints[index];
                }
                return null;
            },
            
            publishBlueprint: (blueprintId) => {
                return EnhancedMockDB.updateBlueprint(blueprintId, { status: 'published' });
            },
            
            archiveBlueprint: (blueprintId) => {
                return EnhancedMockDB.updateBlueprint(blueprintId, { status: 'archived' });
            },
            
            // Payment Management
            createActivation: (activationData) => {
                const data = EnhancedMockDB.load();
                
                // FIX PACK 1: Get tenant-specific delay
                const paymentSettings = EnhancedMockDB.getPaymentSettings(activationData.tenantId);
                const cardDelayMs = (paymentSettings.cardDelaySeconds || 10) * 1000;
                
                const activation = {
                    ...activationData,
                    id: `act_${Date.now()}`,
                    status: activationData.paymentMethod === PAYMENT_CONTRACT.METHODS.WALLET 
                        ? PAYMENT_CONTRACT.STATUSES.LAUNCHED 
                        : PAYMENT_CONTRACT.STATUSES.PENDING_CARD,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                data.activations.push(activation);
                
                // Handle payment
                if (activation.paymentMethod === PAYMENT_CONTRACT.METHODS.WALLET) {
                    // Deduct from wallet
                    const user = data.users.find(u => u.id === activation.userId);
                    if (user) {
                        user.walletBalance -= activation.totalCost;
                    }
                    EnhancedMockDB.addLedgerEntry({
                        type: 'wallet_spend',
                        amount: -activation.totalCost,
                        userId: activation.userId,
                        activationId: activation.id,
                        tenantId: activation.tenantId,
                        description: `Campaign: ${activation.blueprintTitle}`
                    });
                } else {
                    // Card - create hard reserve
                    EnhancedMockDB.addLedgerEntry({
                        type: 'card_reserve',
                        amount: activation.totalCost,
                        userId: activation.userId,
                        activationId: activation.id,
                        tenantId: activation.tenantId,
                        description: `Card hold: ${activation.blueprintTitle}`
                    });
                }
                
                EnhancedMockDB.addAuditLog('activation.create', activation.id, activation.blueprintTitle, activationData.tenantId);
                EnhancedMockDB.save(data);
                
                // Auto-capture after tenant-specific delay for card
                if (activation.paymentMethod === PAYMENT_CONTRACT.METHODS.CARD) {
                    setTimeout(() => {
                        EnhancedMockDB.captureCardPayment(activation.id);
                    }, cardDelayMs);
                }
                
                return activation;
            },
            
            captureCardPayment: (activationId) => {
                const data = EnhancedMockDB.load();
                const activation = data.activations.find(a => a.id === activationId);
                if (activation && activation.status === PAYMENT_CONTRACT.STATUSES.PENDING_CARD) {
                    activation.status = PAYMENT_CONTRACT.STATUSES.CAPTURED;
                    activation.updatedAt = new Date().toISOString();
                    
                    EnhancedMockDB.addLedgerEntry({
                        type: 'card_capture',
                        amount: activation.totalCost,
                        userId: activation.userId,
                        activationId: activation.id,
                        tenantId: activation.tenantId,
                        description: `Card captured: ${activation.blueprintTitle}`
                    });
                    
                    EnhancedMockDB.addAuditLog('payment.capture', activation.id, activation.blueprintTitle, activation.tenantId);
                    EnhancedMockDB.save(data);
                    return activation;
                }
                return null;
            },
            
            failCardPayment: (activationId, reason) => {
                const data = EnhancedMockDB.load();
                const activation = data.activations.find(a => a.id === activationId);
                if (activation && activation.status === PAYMENT_CONTRACT.STATUSES.PENDING_CARD) {
                    activation.status = PAYMENT_CONTRACT.STATUSES.KILLED;
                    activation.failureReason = reason;
                    activation.updatedAt = new Date().toISOString();
                    
                    EnhancedMockDB.addLedgerEntry({
                        type: 'card_failure',
                        amount: -activation.totalCost,
                        userId: activation.userId,
                        activationId: activation.id,
                        tenantId: activation.tenantId,
                        description: `Card failed: ${reason}`
                    });
                    
                    EnhancedMockDB.addAuditLog('payment.fail', activation.id, reason, activation.tenantId);
                    EnhancedMockDB.save(data);
                    return activation;
                }
                return null;
            },
            
            // Dispute Management
            createDispute: (disputeData) => {
                const data = EnhancedMockDB.load();
                const dispute = {
                    ...disputeData,
                    id: `dispute_${Date.now()}`,
                    status: 'open',
                    openedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                data.disputes.push(dispute);
                
                // Auto-kill activation if card-paid
                const activation = data.activations.find(a => a.id === dispute.activationId);
                if (activation && activation.paymentMethod === PAYMENT_CONTRACT.METHODS.CARD) {
                    activation.status = PAYMENT_CONTRACT.STATUSES.KILLED;
                    activation.disputeId = dispute.id;
                    activation.updatedAt = new Date().toISOString();
                    
                    // Auto-freeze user payments if enabled
                    const paymentSettings = EnhancedMockDB.getPaymentSettings(activation.tenantId);
                    if (paymentSettings.killSwitchOnDispute) {
                        const user = data.users.find(u => u.id === dispute.userId);
                        if (user) {
                            user.paymentFrozen = true;
                        }
                    }
                }
                
                EnhancedMockDB.addAuditLog('dispute.create', dispute.id, `Activation: ${activation?.blueprintTitle}`, disputeData.tenantId);
                EnhancedMockDB.save(data);
                return dispute;
            },
            
            resolveDispute: (disputeId, resolution) => {
                const data = EnhancedMockDB.load();
                const dispute = data.disputes.find(d => d.id === disputeId);
                if (dispute) {
                    dispute.status = resolution.status;
                    dispute.resolution = resolution;
                    dispute.resolvedAt = new Date().toISOString();
                    dispute.updatedAt = new Date().toISOString();
                    
                    EnhancedMockDB.addAuditLog('dispute.resolve', disputeId, resolution.status, dispute.tenantId);
                    EnhancedMockDB.save(data);
                    return dispute;
                }
                return null;
            },
            
            // Refund Management
            issueRefund: (refundData) => {
                const data = EnhancedMockDB.load();
                const refund = {
                    ...refundData,
                    id: `refund_${Date.now()}`,
                    issuedAt: new Date().toISOString()
                };
                
                // Handle based on destination
                if (refund.destination === 'wallet') {
                    const user = data.users.find(u => u.id === refund.userId);
                    if (user) {
                        user.walletBalance += refund.amount;
                    }
                }
                
                // Update activation status if full refund
                const activation = data.activations.find(a => a.id === refund.activationId);
                if (activation && refund.amount >= activation.totalCost) {
                    activation.status = PAYMENT_CONTRACT.STATUSES.REFUNDED;
                    activation.updatedAt = new Date().toISOString();
                }
                
                EnhancedMockDB.addLedgerEntry({
                    type: 'refund',
                    amount: refund.amount,
                    userId: refund.userId,
                    activationId: refund.activationId,
                    tenantId: refund.tenantId,
                    description: `Refund to ${refund.destination}: ${refund.reason || 'No reason provided'}`
                });
                
                EnhancedMockDB.addAuditLog('refund.issue', refund.id, `${refund.amount} to ${refund.destination}`, refund.tenantId);
                EnhancedMockDB.save(data);
                return refund;
            },
            
            // User Management
            updateUser: (userId, updates) => {
                const data = EnhancedMockDB.load();
                const user = data.users.find(u => u.id === userId);
                if (user) {
                    Object.assign(user, updates, { updatedAt: new Date().toISOString() });
                    EnhancedMockDB.addAuditLog('user.update', userId, Object.keys(updates).join(', '), user.tenantId);
                    EnhancedMockDB.save(data);
                    return user;
                }
                return null;
            },
            
            adjustWalletBalance: (userId, amount, reason) => {
                const data = EnhancedMockDB.load();
                const user = data.users.find(u => u.id === userId);
                if (user) {
                    user.walletBalance += amount;
                    
                    EnhancedMockDB.addLedgerEntry({
                        type: amount > 0 ? 'wallet_credit' : 'wallet_debit',
                        amount: amount,
                        userId: userId,
                        tenantId: user.tenantId,
                        description: reason || 'Balance adjustment'
                    });
                    
                    EnhancedMockDB.addAuditLog('wallet.adjust', userId, `${amount > 0 ? '+' : ''}${amount}: ${reason}`, user.tenantId);
                    EnhancedMockDB.save(data);
                    return user;
                }
                return null;
            },
            
            // Mail Buckets
            createMailBucket: (bucketData) => {
                const data = EnhancedMockDB.load();
                // FIX PACK 1: Enforce tenantId
                if (!bucketData.tenantId) {
                    console.error('Mail bucket creation requires tenantId');
                    return null;
                }
                
                const bucket = {
                    ...bucketData,
                    id: `bucket_${Date.now()}`,
                    contacts: 0,
                    sent: 0,
                    delivered: 0,
                    opened: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                data.mailBuckets.push(bucket);
                EnhancedMockDB.addAuditLog('mail_bucket.create', bucket.id, bucket.name, bucketData.tenantId);
                EnhancedMockDB.save(data);
                return bucket;
            },
            
            sendMailCampaign: (bucketId, campaignData) => {
                const data = EnhancedMockDB.load();
                const bucket = data.mailBuckets.find(b => b.id === bucketId);
                if (bucket) {
                    // Mock sending with deterministic results
                    const sent = Math.min(bucket.contacts, 100); // Max 100 per send
                    const delivered = Math.floor(sent * 0.98);
                    const opened = Math.floor(delivered * 0.75);
                    
                    bucket.sent += sent;
                    bucket.delivered += delivered;
                    bucket.opened += opened;
                    bucket.updatedAt = new Date().toISOString();
                    
                    EnhancedMockDB.addAuditLog('mail.send', bucketId, `Sent to ${sent}, Opened: ${opened}`, bucket.tenantId);
                    EnhancedMockDB.save(data);
                    
                    return {
                        sent,
                        delivered,
                        opened,
                        campaignId: `campaign_${Date.now()}`
                    };
                }
                return null;
            },
            
            // Audit & Ledger
            addAuditLog: (action, entityId, summary, tenantId) => {
                const data = EnhancedMockDB.load();
                data.auditLog.push({
                    id: `audit_${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    actor: 'admin', // Would be current user in real system
                    action,
                    entity: action.split('.')[0],
                    entityId,
                    summary,
                    tenantId
                });
                EnhancedMockDB.save(data);
            },
            
            addLedgerEntry: (entry) => {
                const data = EnhancedMockDB.load();
                // FIX PACK 1: Enforce tenantId on ledger
                if (!entry.tenantId) {
                    console.error('Ledger entry requires tenantId');
                    return;
                }
                
                data.ledger.push({
                    ...entry,
                    id: `ledger_${Date.now()}`,
                    timestamp: new Date().toISOString()
                });
                EnhancedMockDB.save(data);
            },
            
            // FIX PACK 1: Ledger filtering helper
            getLedgerForTenant: (tenantId) => {
                const data = EnhancedMockDB.load();
                return data.ledger.filter(entry => entry.tenantId === tenantId);
            },
            
            // AI Mock Adapter
            runBlueprintHealthCheck: (blueprintId) => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        const checks = {
                            compliance: Math.random() > 0.2 ? 'pass' : 'warning',
                            clarity: Math.floor(Math.random() * 30) + 70,
                            cta: Math.floor(Math.random() * 30) + 70,
                            suggestions: [
                                'Consider adding social proof',
                                'Test different headlines',
                                'Add urgency to CTA'
                            ].slice(0, Math.floor(Math.random() * 3) + 1)
                        };
                        resolve(checks);
                    }, 500 + Math.random() * 300); // 500-800ms delay
                });
            },
            
            generateEmailContent: () => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        const subjects = [
                            'Boost Your Campaign Performance',
                            'New Features Available',
                            'Important Update from honeii',
                            'Maximize Your Earnings'
                        ];
                        const bodies = [
                            'We\'re excited to share some tips to improve your campaign results...',
                            'Check out our latest features designed to help you succeed...',
                            'This update includes important information about your account...',
                            'Here are strategies to increase your commission earnings...'
                        ];
                        resolve({
                            subject: subjects[Math.floor(Math.random() * subjects.length)],
                            body: bodies[Math.floor(Math.random() * bodies.length)]
                        });
                    }, 300 + Math.random() * 200); // 300-500ms delay
                });
            },
            
            // Analytics
            getDashboardMetrics: (tenantId) => {
                const data = EnhancedMockDB.load();
                const now = new Date();
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                
                // FIX PACK 1: Tenant-scoped metrics
                const tenantActivations = data.activations.filter(a => 
                    !tenantId || a.tenantId === tenantId
                );
                
                const totalSpend = tenantActivations.reduce((sum, act) => sum + (act.totalCost || 0), 0);
                const activeActivations = tenantActivations.filter(a => 
                    a.status === PAYMENT_CONTRACT.STATUSES.LAUNCHED || 
                    a.status === PAYMENT_CONTRACT.STATUSES.CAPTURED
                ).length;
                const pendingCard = tenantActivations.filter(a => 
                    a.status === PAYMENT_CONTRACT.STATUSES.PENDING_CARD
                ).length;
                
                const tenantDisputes = data.disputes.filter(d => 
                    !tenantId || d.tenantId === tenantId
                );
                const openDisputes = tenantDisputes.filter(d => d.status === 'open').length;
                
                const tenantMailBuckets = data.mailBuckets.filter(b => 
                    !tenantId || b.tenantId === tenantId
                );
                const emailsSent = tenantMailBuckets.reduce((sum, bucket) => sum + bucket.sent, 0);
                
                return {
                    totalSpend,
                    activeActivations,
                    pendingCard,
                    openDisputes,
                    emailsSent,
                    trend: {
                        totalSpend: Math.floor(totalSpend * 0.12), // +12% trend
                        activeActivations: Math.floor(activeActivations * 0.08) // +8% trend
                    }
                };
            }
        };

        // ==========================================================
        // MAIN APPLICATION
        // ==========================================================
        const App = () => {
            const [db, setDb] = React.useState(EnhancedMockDB.load());
            const [userRole, setUserRole] = React.useState(localStorage.getItem('honeii_role') || 'honeii_admin');
            const [currentView, setCurrentView] = React.useState(
                localStorage.getItem('honeii_role') === 'honeii_admin' ? 'tenant-manager' : 'admin-dashboard'
            );
            const [toast, setToast] = React.useState(null);
            const [modalContent, setModalContent] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [currentUser, setCurrentUser] = React.useState(() => {
                const storedRole = localStorage.getItem('honeii_role');
                const data = EnhancedMockDB.load();
                if (storedRole === 'honeii_admin') {
                    return data.users.find(u => u.role === 'honeii_admin') || data.users[0];
                } else if (storedRole === 'company_admin') {
                    return data.users.find(u => u.role === 'company_admin') || data.users[1];
                }
                return data.users.find(u => u.role === 'distributor') || data.users[2];
            });
            
            // Auto-save and auto-hide
            React.useEffect(() => {
                EnhancedMockDB.save(db);
                
                // Update current user if data changed
                if (currentUser) {
                    const updatedUser = db.users.find(u => u.id === currentUser.id);
                    if (updatedUser) {
                        setCurrentUser(updatedUser);
                    }
                }
            }, [db, currentUser]);
            
            React.useEffect(() => {
                const storedRole = localStorage.getItem('honeii_role');
                const data = EnhancedMockDB.load();
                
                if (storedRole === 'honeii_admin') {
                    const honeiiAdmin = data.users.find(u => u.role === 'honeii_admin') || data.users[0];
                    setCurrentUser(honeiiAdmin);
                    if (!currentView.includes('tenant-')) {
                        setCurrentView('tenant-manager');
                    }
                } else if (storedRole === 'company_admin') {
                    const companyAdmin = data.users.find(u => u.role === 'company_admin') || data.users[1];
                    setCurrentUser(companyAdmin);
                    if (!currentView.includes('admin-')) {
                        setCurrentView('admin-dashboard');
                    }
                } else if (storedRole === 'distributor') {
                    const distributor = data.users.find(u => u.role === 'distributor') || data.users[2];
                    setCurrentUser(distributor);
                    if (!currentView.includes('campaign-') && !currentView.includes('wallet')) {
                        setCurrentView('campaign-hub');
                    }
                }
            }, [db]);
            
            React.useEffect(() => {
                if (toast) {
                    const timer = setTimeout(() => setToast(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [toast]);
            
            const showToast = (message, type = 'success') => {
                setToast({ message, type });
            };
            
            const updateDb = (updates) => {
                setDb(prev => {
                    const newData = { ...prev, ...updates };
                    EnhancedMockDB.save(newData);
                    return newData;
                });
            };
            
            const switchRole = (role) => {
                setUserRole(role);
                localStorage.setItem('honeii_role', role);
                const data = EnhancedMockDB.load();
                
                if (role === 'honeii_admin') {
                    const honeiiAdmin = data.users.find(u => u.role === 'honeii_admin') || data.users[0];
                    setCurrentUser(honeiiAdmin);
                    setCurrentView('tenant-manager');
                } else if (role === 'company_admin') {
                    const companyAdmin = data.users.find(u => u.role === 'company_admin') || data.users[1];
                    setCurrentUser(companyAdmin);
                    setCurrentView('admin-dashboard');
                } else if (role === 'distributor') {
                    const distributor = data.users.find(u => u.role === 'distributor') || data.users[2];
                    setCurrentUser(distributor);
                    setCurrentView('campaign-hub');
                }
            };
            
            const closeModal = () => {
                setModalContent(null);
            };
            
            const withLoading = async (fn) => {
                setLoading(true);
                try {
                    const result = await fn();
                    return result;
                } finally {
                    setLoading(false);
                }
            };
            
            // ==================== HEADER ====================
            const Header = () => {
                return e('div', { className: 'header' }, [
                    e('div', { 
                        key: 'logo',
                        style: { 
                            fontSize: '24px', 
                            fontWeight: '700',
                            color: 'var(--brand)'
                        }
                    }, 'honeii'),
                    
                    e('select', {
                        key: 'role-selector',
                        value: userRole,
                        onChange: (e) => switchRole(e.target.value),
                        style: {
                            padding: '8px 16px',
                            borderRadius: '6px',
                            border: '1px solid var(--border)',
                            background: 'white',
                            fontSize: '14px',
                            cursor: 'pointer'
                        }
                    }, [
                        e('option', { key: 'honeii_admin', value: 'honeii_admin' }, 'Honeii Admin'),
                        e('option', { key: 'company_admin', value: 'company_admin' }, 'Company Admin'),
                        e('option', { key: 'distributor', value: 'distributor' }, 'Distributor View')
                    ])
                ]);
            };
            
            // ==================== HONEII ADMIN SIDEBAR ====================
            const HoneiiAdminSidebar = () => {
                const navSections = [
                    {
                        title: 'Tenant Management',
                        items: [
                            { id: 'tenant-manager', label: 'Tenants', icon: 'ðŸ¢' },
                            { id: 'tenant-analytics', label: 'Analytics', icon: 'ðŸ“ˆ' },
                            { id: 'tenant-payments', label: 'Payment Settings', icon: 'ðŸ’³' },
                            { id: 'tenant-discounts', label: 'Discount Settings', icon: 'ðŸ’°' }
                        ]
                    },
                    {
                        title: 'System',
                        items: [
                            { id: 'system-settings', label: 'Settings', icon: 'âš™ï¸' },
                            { id: 'system-audit', label: 'Audit Log', icon: 'ðŸ“' },
                            { id: 'system-ledger', label: 'Ledger', icon: 'ðŸ“’' }
                        ]
                    }
                ];
                
                return e('div', { className: 'sidebar tenant-sidebar' }, [
                    e('div', { key: 'header', className: 'sidebar-header' }, [
                        e('div', { 
                            style: { 
                                fontSize: '20px', 
                                fontWeight: '700',
                                color: 'white',
                                marginBottom: '4px'
                            }
                        }, 'honeii'),
                        e('div', { 
                            style: { 
                                fontSize: '12px',
                                color: '#94a3b8',
                                fontWeight: '600',
                                textTransform: 'uppercase'
                            }
                        }, 'Super Admin Panel')
                    ]),
                    ...navSections.flatMap(section => [
                        e('div', { key: `section-${section.title}`, className: 'admin-nav-section' }, section.title),
                        ...section.items.map(item => 
                            e('div', {
                                key: item.id,
                                className: `admin-nav-item ${currentView === item.id ? 'active' : ''}`,
                                onClick: () => setCurrentView(item.id)
                            }, [
                                e('span', { key: 'icon' }, item.icon),
                                e('span', { key: 'label' }, item.label)
                            ])
                        )
                    ])
                ]);
            };
            
            // ==================== COMPANY ADMIN SIDEBAR ====================
            const CompanyAdminSidebar = () => {
                const currentTenant = db.tenants.find(t => t.id === currentUser?.tenantId) || db.tenants[0];
                
                const navSections = [
                    {
                        title: 'Overview',
                        items: [
                            { id: 'admin-dashboard', label: 'Dashboard', icon: 'ðŸ“Š' }
                        ]
                    },
                    {
                        title: 'Campaigns',
                        items: [
                            { id: 'blueprints', label: 'Blueprints', icon: 'ðŸ“‹' }
                        ]
                    },
                    {
                        title: 'Users',
                        items: [
                            { id: 'users-permissions', label: 'Users & Permissions', icon: 'ðŸ‘¥' }
                        ]
                    },
                    {
                        title: 'Settings',
                        items: [
                            { id: 'settings', label: 'Company Settings', icon: 'âš™ï¸' },
                            { id: 'payment-control', label: 'Payment Settings', icon: 'ðŸ’³' },
                            { id: 'discounts-settings', label: 'Discount Settings', icon: 'ðŸ’°' }
                        ]
                    }
                ];
                
                return e('div', { className: 'sidebar company-sidebar' }, [
                    e('div', { key: 'header', className: 'sidebar-header' }, [
                        e('div', { 
                            style: { 
                                fontSize: '16px', 
                                fontWeight: '700',
                                color: 'white',
                                marginBottom: '4px'
                            }
                        }, currentTenant?.name || 'Company'),
                        e('div', { 
                            style: { 
                                fontSize: '11px',
                                color: '#94a3b8',
                                fontWeight: '600',
                                textTransform: 'uppercase'
                            }
                        }, 'Admin Panel')
                    ]),
                    ...navSections.flatMap(section => [
                        e('div', { key: `section-${section.title}`, className: 'admin-nav-section' }, section.title),
                        ...section.items.map(item => 
                            e('div', {
                                key: item.id,
                                className: `admin-nav-item ${currentView === item.id ? 'active' : ''}`,
                                onClick: () => setCurrentView(item.id)
                            }, [
                                e('span', { key: 'icon' }, item.icon),
                                e('span', { key: 'label' }, item.label)
                            ])
                        )
                    ])
                ]);
            };
            
            // ==================== DISTRIBUTOR SIDEBAR ====================
            const DistributorSidebar = () => {
                const navItems = [
                    { id: 'campaign-hub', label: 'Campaign Hub', icon: 'ðŸ ' },
                    { id: 'my-campaigns', label: 'My Campaigns', icon: 'ðŸ“Š' },
                    { id: 'wallet', label: 'Wallet', icon: 'ðŸ’°' },
                    { id: 'distributor-ledger', label: 'Transaction History', icon: 'ðŸ“’' }
                ];
                
                return e('div', { className: 'sidebar' },
                    navItems.map(item => 
                        e('div', {
                            key: item.id,
                            className: `admin-nav-item ${currentView === item.id ? 'active' : ''}`,
                            onClick: () => setCurrentView(item.id)
                        }, [
                            e('span', { key: 'icon', className: 'nav-icon' }, item.icon),
                            e('span', { key: 'label' }, item.label)
                        ])
                    )
                );
            };
            
            // ==================== TOAST & MODAL ====================
            const Toast = () => {
                if (!toast) return null;
                
                return e('div', { 
                    className: 'admin-btn', 
                    style: {
                        position: 'fixed',
                        bottom: '20px',
                        right: '20px',
                        background: toast.type === 'error' ? 'var(--error)' : 'var(--success)',
                        color: 'white',
                        padding: '12px 24px',
                        borderRadius: '8px',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                        zIndex: 1000
                    }
                }, toast.message);
            };
            
            const Modal = () => {
                if (!modalContent) return null;
                
                return e('div', { className: 'admin-modal-overlay', onClick: closeModal },
                    e('div', { className: 'admin-modal', onClick: (e) => e.stopPropagation() }, modalContent)
                );
            };
            
            const LoadingOverlay = () => {
                if (!loading) return null;
                
                return e('div', {
                    className: 'admin-modal-overlay',
                    style: { background: 'rgba(0,0,0,0.7)', alignItems: 'center', justifyContent: 'center' }
                }, [
                    e('div', { 
                        key: 'spinner',
                        style: {
                            width: '50px',
                            height: '50px',
                            border: '4px solid var(--border)',
                            borderTopColor: 'var(--brand)',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }
                    }),
                    e('style', { key: 'style' }, `
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    `)
                ]);
            };
            
            // ==================== ADMIN VIEWS ====================
            
            // TENANT MANAGER (Honeii Admin)
            const TenantManager = () => {
                const filteredTenants = db.tenants.filter(tenant => 
                    userRole === 'honeii_admin' ? true : tenant.id === currentUser?.tenantId
                );
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('div', { key: 'title' }, [
                            e('h1', { className: 'admin-section-title' }, 'Tenant Management'),
                            e('p', { className: 'admin-section-subtitle' }, 'Manage all companies and organizations' )
                        ])
                    ]),
                    
                    e('div', { key: 'table', className: 'admin-section' }, [
                        e('table', { className: 'admin-table' }, [
                            e('thead', { key: 'head' }, [
                                e('tr', { key: 'row' }, [
                                    e('th', { key: 'name' }, 'Tenant Name'),
                                    e('th', { key: 'status' }, 'Status'),
                                    e('th', { key: 'users' }, 'Users'),
                                    e('th', { key: 'campaigns' }, 'Campaigns'),
                                    e('th', { key: 'spend' }, 'Monthly Spend'),
                                    e('th', { key: 'plan' }, 'Plan'),
                                    e('th', { key: 'actions' }, 'Actions')
                                ])
                            ]),
                            e('tbody', { key: 'body' },
                                filteredTenants.map(tenant => 
                                    e('tr', { key: tenant.id }, [
                                        e('td', { key: 'name' }, tenant.name),
                                        e('td', { key: 'status' },
                                            e('span', { className: 'admin-badge badge-success' }, tenant.status.toUpperCase())
                                        ),
                                        e('td', { key: 'users' }, tenant.users),
                                        e('td', { key: 'campaigns' }, tenant.campaigns),
                                        e('td', { key: 'spend' }, `$${tenant.monthlySpend}`),
                                        e('td', { key: 'plan' },
                                            e('span', { className: 'admin-badge badge-info' }, tenant.plan.toUpperCase())
                                        ),
                                        e('td', { key: 'actions' }, 'â€”')
                                    ])
                                )
                            )
                        ])
                    ])
                ]);
            };
            
            // HONEII ADMIN - PAYMENT SETTINGS PER TENANT
            const TenantPaymentSettings = () => {
                const [selectedTenant, setSelectedTenant] = React.useState(db.tenants[0]?.id);
                const [paymentSettings, setPaymentSettings] = React.useState(() => {
                    return selectedTenant ? EnhancedMockDB.getPaymentSettings(selectedTenant) : {};
                });
                
                React.useEffect(() => {
                    if (selectedTenant) {
                        const settings = EnhancedMockDB.getPaymentSettings(selectedTenant);
                        setPaymentSettings(settings);
                    }
                }, [selectedTenant]);
                
                const handleSettingChange = (key, value) => {
                    const newSettings = { ...paymentSettings, [key]: value };
                    setPaymentSettings(newSettings);
                    EnhancedMockDB.setPaymentSettings(selectedTenant, newSettings);
                    showToast('Payment settings updated');
                    setDb(EnhancedMockDB.load());
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'Per-Tenant Payment Settings'),
                        e('p', { className: 'admin-section-subtitle' }, 'Configure payment rules for each tenant' )
                    ]),
                    
                    e('div', { key: 'selector', className: 'admin-section' }, [
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Select Tenant'),
                            e('select', {
                                className: 'admin-form-input',
                                value: selectedTenant,
                                onChange: (e) => setSelectedTenant(e.target.value)
                            }, db.tenants.map(tenant => 
                                e('option', { key: tenant.id, value: tenant.id }, tenant.name)
                            ))
                        ])
                    ]),
                    
                    selectedTenant && e('div', { key: 'settings', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '24px' } }, `Settings for ${db.tenants.find(t => t.id === selectedTenant)?.name}`),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Card Delayed Launch'),
                                    e('div', { className: 'text-secondary' }, 'Cards require verification before campaigns go live' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: paymentSettings.cardDelayedLaunch,
                                        onChange: (e) => handleSettingChange('cardDelayedLaunch', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Card Verification Delay (seconds)'),
                            e('input', {
                                type: 'range',
                                className: 'admin-form-input',
                                min: '5',
                                max: '30',
                                value: paymentSettings.cardDelaySeconds || 10,
                                onChange: (e) => handleSettingChange('cardDelaySeconds', parseInt(e.target.value))
                            }),
                            e('div', { className: 'text-secondary' }, `${paymentSettings.cardDelaySeconds || 10} seconds` )
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Enable Card Payments'),
                                    e('div', { className: 'text-secondary' }, 'Allow card payments for this tenant' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: paymentSettings.cardPaymentsEnabled,
                                        onChange: (e) => handleSettingChange('cardPaymentsEnabled', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Dispute Auto-Kill'),
                                    e('div', { className: 'text-secondary' }, 'Automatically kill campaigns when disputes are opened' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: paymentSettings.killSwitchOnDispute,
                                        onChange: (e) => handleSettingChange('killSwitchOnDispute', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Default Card Refund Destination'),
                            e('select', {
                                className: 'admin-form-input',
                                value: paymentSettings.defaultCardRefund || 'gift_card',
                                onChange: (e) => handleSettingChange('defaultCardRefund', e.target.value)
                            }, PAYMENT_CONTRACT.RULES.REFUND_DESTINATIONS.map(dest => 
                                e('option', { key: dest, value: dest }, dest.replace('_', ' ').toUpperCase())
                            ))
                        ])
                    ])
                ]);
            };
            
            // HONEII ADMIN - DISCOUNT SETTINGS PER TENANT
            const TenantDiscountSettings = () => {
                const [selectedTenant, setSelectedTenant] = React.useState(db.tenants[0]?.id);
                const [discountSettings, setDiscountSettings] = React.useState(() => {
                    return selectedTenant ? EnhancedMockDB.getDiscountSettings(selectedTenant) : {};
                });
                
                React.useEffect(() => {
                    if (selectedTenant) {
                        const settings = EnhancedMockDB.getDiscountSettings(selectedTenant);
                        setDiscountSettings(settings);
                    }
                }, [selectedTenant]);
                
                const handleSettingChange = (key, value) => {
                    const newSettings = { ...discountSettings, [key]: value };
                    setDiscountSettings(newSettings);
                    EnhancedMockDB.setDiscountSettings(selectedTenant, newSettings);
                    showToast('Discount settings updated');
                    setDb(EnhancedMockDB.load());
                };
                
                const handleUpdateDiscount = (index, value) => {
                    const newOptions = [...discountSettings.options];
                    newOptions[index].value = parseFloat(value);
                    handleSettingChange('options', newOptions);
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'Per-Tenant Discount Settings'),
                        e('p', { className: 'admin-section-subtitle' }, 'Configure discount options for each tenant' )
                    ]),
                    
                    e('div', { key: 'selector', className: 'admin-section' }, [
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Select Tenant'),
                            e('select', {
                                className: 'admin-form-input',
                                value: selectedTenant,
                                onChange: (e) => setSelectedTenant(e.target.value)
                            }, db.tenants.map(tenant => 
                                e('option', { key: tenant.id, value: tenant.id }, tenant.name)
                            ))
                        ])
                    ]),
                    
                    selectedTenant && e('div', { key: 'settings', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '24px' } }, `Settings for ${db.tenants.find(t => t.id === selectedTenant)?.name}`),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Enable Distributor Discounts'),
                                    e('div', { className: 'text-secondary' }, 'Allow distributors to offer discounts to customers' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: discountSettings.enabled,
                                        onChange: (e) => handleSettingChange('enabled', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        discountSettings.enabled && e('div', null, [
                            e('h3', { style: { margin: '24px 0 16px' } }, 'Discount Options'),
                            
                            e('div', { className: 'flex gap-4' },
                                discountSettings.options.map((option, index) => 
                                    e('div', { key: option.id, className: 'admin-form-group', style: { flex: 1 } }, [
                                        e('label', { className: 'admin-form-label' }, option.label),
                                        e('input', {
                                            type: 'number',
                                            className: 'admin-form-input',
                                            value: option.value,
                                            onChange: (e) => handleUpdateDiscount(index, e.target.value),
                                            min: 0,
                                            max: 100,
                                            step: 0.5
                                        })
                                    ])
                                )
                            ),
                            
                            e('div', { className: 'admin-form-group', style: { marginTop: '24px' } }, [
                                e('label', { className: 'admin-form-label' }, 'Fast Start Split Ratio'),
                                e('input', {
                                    type: 'range',
                                    className: 'admin-form-input',
                                    min: '0',
                                    max: '100',
                                    value: (discountSettings.fastStartSplit || 0.5) * 100,
                                    onChange: (e) => handleSettingChange('fastStartSplit', parseInt(e.target.value) / 100)
                                }),
                                e('div', { className: 'text-secondary' }, 
                                    `${Math.round((discountSettings.fastStartSplit || 0.5) * 100)}% goes to distributor, ${Math.round((1 - (discountSettings.fastStartSplit || 0.5)) * 100)}% goes to customer discount`
                                )
                            ])
                        ])
                    ])
                ]);
            };
            
            // HONEII ADMIN - LEDGER VIEW
            const SystemLedger = () => {
                const [selectedTenant, setSelectedTenant] = React.useState('all');
                const [ledgerEntries, setLedgerEntries] = React.useState([]);
                
                React.useEffect(() => {
                    const data = EnhancedMockDB.load();
                    let filtered = data.ledger;
                    if (selectedTenant !== 'all') {
                        filtered = data.ledger.filter(entry => entry.tenantId === selectedTenant);
                    }
                    setLedgerEntries(filtered.slice().reverse());
                }, [selectedTenant, db]);
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'System Ledger'),
                        e('p', { className: 'admin-section-subtitle' }, 'All financial transactions across tenants' )
                    ]),
                    
                    e('div', { key: 'filters', className: 'admin-section' }, [
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Filter by Tenant'),
                            e('select', {
                                className: 'admin-form-input',
                                value: selectedTenant,
                                onChange: (e) => setSelectedTenant(e.target.value)
                            }, [
                                e('option', { key: 'all', value: 'all' }, 'All Tenants'),
                                ...db.tenants.map(tenant => 
                                    e('option', { key: tenant.id, value: tenant.id }, tenant.name)
                                )
                            ])
                        ])
                    ]),
                    
                    e('div', { key: 'table', className: 'admin-section' }, [
                        ledgerEntries.length === 0 ? 
                            e('div', { style: { textAlign: 'center', padding: '48px', color: 'var(--text-secondary)' } }, 
                                'No ledger entries found' ) :
                            e('table', { className: 'admin-table' }, [
                                e('thead', { key: 'head' }, [
                                    e('tr', { key: 'row' }, [
                                        e('th', { key: 'time' }, 'Time'),
                                        e('th', { key: 'tenant' }, 'Tenant'),
                                        e('th', { key: 'type' }, 'Type'),
                                        e('th', { key: 'amount' }, 'Amount'),
                                        e('th', { key: 'description' }, 'Description'),
                                        e('th', { key: 'user' }, 'User')
                                    ])
                                ]),
                                e('tbody', { key: 'body' },
                                    ledgerEntries.map(entry => {
                                        const tenant = db.tenants.find(t => t.id === entry.tenantId);
                                        const user = db.users.find(u => u.id === entry.userId);
                                        
                                        return e('tr', { key: entry.id }, [
                                            e('td', { key: 'time' }, 
                                                new Date(entry.timestamp).toLocaleString()
                                            ),
                                            e('td', { key: 'tenant' }, tenant?.name || entry.tenantId),
                                            e('td', { key: 'type' },
                                                e('span', {
                                                    className: `admin-badge ${
                                                        entry.type.includes('credit') ? 'badge-success' :
                                                        entry.type.includes('debit') || entry.type.includes('spend') ? 'badge-error' :
                                                        'badge-info'
                                                    }`
                                                }, entry.type.replace('_', ' ').toUpperCase())
                                            ),
                                            e('td', { key: 'amount' }, 
                                                e('span', { style: { 
                                                    color: entry.amount >= 0 ? 'var(--success)' : 'var(--error)',
                                                    fontWeight: '600'
                                                }}, `$${Math.abs(entry.amount)} ${entry.amount >= 0 ? '+' : '-'}`)
                                            ),
                                            e('td', { key: 'description' }, entry.description),
                                            e('td', { key: 'user' }, user?.name || 'Unknown')
                                        ]);
                                    })
                                )
                            ])
                    ])
                ]);
            };
            
            // 1. ADMIN DASHBOARD
            const AdminDashboard = () => {
                const tenantId = currentUser?.tenantId;
                const metrics = EnhancedMockDB.getDashboardMetrics(userRole === 'company_admin' ? tenantId : null);
                
                const quickActions = [
                    { label: 'Create Blueprint', icon: 'âž•', action: () => setCurrentView('blueprints'), view: 'blueprints' },
                    { label: 'Review Card Launches', icon: 'ðŸ’³', action: () => setCurrentView('payment-control'), view: 'payment-control' },
                    { label: 'Open Disputes', icon: 'âš–ï¸', action: () => setCurrentView('dispute-manager'), view: 'dispute-manager' },
                    { label: 'Send Email', icon: 'ðŸ“§', action: () => setCurrentView('mail-buckets'), view: 'mail-buckets' }
                ];
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('div', { key: 'title' }, [
                            e('h1', { className: 'admin-section-title' }, 'Admin Dashboard'),
                            e('p', { className: 'admin-section-subtitle' }, 'System overview and quick actions' )
                        ])
                    ]),
                    
                    e('div', { key: 'metrics', className: 'kpi-grid' }, [
                        e('div', { key: 'spend', className: 'kpi-card' }, [
                            e('div', { className: 'kpi-label' }, 'Total Spend'),
                            e('div', { className: 'kpi-value' }, `$${metrics.totalSpend.toLocaleString()}`),
                            e('div', { className: 'kpi-trend' }, `+${metrics.trend.totalSpend}% this month` )
                        ]),
                        
                        e('div', { key: 'active', className: 'kpi-card' }, [
                            e('div', { className: 'kpi-label' }, 'Active Campaigns'),
                            e('div', { className: 'kpi-value' }, metrics.activeActivations),
                            e('div', { className: 'kpi-trend' }, `+${metrics.trend.activeActivations} from last week` )
                        ]),
                        
                        e('div', { key: 'pending', className: 'kpi-card' }, [
                            e('div', { className: 'kpi-label' }, 'Pending Card'),
                            e('div', { className: 'kpi-value' }, metrics.pendingCard),
                            e('div', { className: 'kpi-trend' }, 'Awaiting verification' )
                        ]),
                        
                        e('div', { key: 'disputes', className: 'kpi-card' }, [
                            e('div', { className: 'kpi-label' }, 'Open Disputes'),
                            e('div', { className: 'kpi-value' }, metrics.openDisputes),
                            e('div', { className: 'kpi-trend' }, 'Requires attention' )
                        ])
                    ]),
                    
                    e('div', { key: 'actions', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '16px' } }, 'Quick Actions'),
                        e('div', { className: 'flex gap-4' },
                            quickActions.map(action => 
                                e('button', {
                                    key: action.label,
                                    className: 'admin-btn admin-btn-secondary',
                                    onClick: action.action,
                                    style: { flex: 1, padding: '16px' }
                                }, [
                                    e('div', { style: { fontSize: '24px', marginBottom: '8px' } }, action.icon),
                                    e('div', null, action.label)
                                ])
                            )
                        )
                    ]),
                    
                    e('div', { key: 'chart', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '16px' } }, 'Spend Trend'),
                        e('div', { className: 'admin-chart' }, [
                            e('div', { 
                                style: { 
                                    height: '200px', 
                                    display: 'flex', 
                                    alignItems: 'flex-end', 
                                    gap: '8px',
                                    padding: '20px 0'
                                } },
                                [40, 65, 80, 95, 120, 150].map((height, i) =>
                                    e('div', {
                                        key: i,
                                        style: {
                                            flex: 1,
                                            height: `${height}px`,
                                            background: 'var(--brand)',
                                            borderRadius: '4px 4px 0 0',
                                            position: 'relative'
                                        }
                                    }, [
                                        e('div', {
                                            style: {
                                                position: 'absolute',
                                                top: '-25px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                fontSize: '12px',
                                                color: 'var(--text-secondary)'
                                            }
                                        }, `Week ${i + 1}`),
                                        e('div', {
                                            style: {
                                                position: 'absolute',
                                                bottom: '-25px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                fontSize: '12px',
                                                color: 'var(--text)',
                                                fontWeight: '600'
                                            }
                                        }, `$${height * 100}`)
                                    ])
                                )
                            )
                        ])
                    ])
                ]);
            };
            
            // 2. BLUEPRINTS MANAGER - FIXED
            const BlueprintsManager = () => {
                // CRITICAL FIX: Safe array guard and tenant filtering
                const dbBlueprints = Array.isArray(db.blueprints) ? db.blueprints : [];
                const tenantId = currentUser?.tenantId;
                
                // Tenant isolation guard
                if (userRole === 'company_admin' && !tenantId) {
                    return e('div', { className: 'admin-panel' }, [
                        e('div', { className: 'admin-section' }, [
                            e('h1', { className: 'admin-section-title' }, 'Configuration Error'),
                            e('p', { className: 'admin-section-subtitle' }, 
                                'Your account is missing tenant configuration. Please contact support.'
                            )
                        ])
                    ]);
                }
                
                // Tenant-scoped filtering with safe fallback
                const tenantScopedBlueprints = dbBlueprints.filter(bp => {
                    if (userRole === 'honeii_admin') return true;
                    return bp.tenantId === tenantId;
                });
                
                // Ensure it's always an array for .map
                const visibleBlueprints = Array.isArray(tenantScopedBlueprints) ? tenantScopedBlueprints : [];
                
                const [editingBlueprint, setEditingBlueprint] = React.useState(null);
                const [healthCheckResults, setHealthCheckResults] = React.useState({});
                
                const handleCreateBlueprint = () => {
                    // FIX PACK 1: Enforce tenantId for company_admin
                    if (userRole === 'company_admin' && !tenantId) {
                        showToast('Cannot create blueprint: missing tenant configuration', 'error');
                        return;
                    }
                    
                    setModalContent([
                        e('div', { className: 'admin-section-header' }, [
                            e('h2', { className: 'admin-section-title' }, 'Create Blueprint'),
                            e('button', { onClick: closeModal, style: { background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer' } }, 'Ã—')
                        ]),
                        e(BlueprintForm, {
                            key: 'form',
                            onSave: (data) => {
                                // FIX PACK 1: Always include tenantId
                                const blueprintData = {
                                    ...data, 
                                    tenantId: userRole === 'company_admin' ? tenantId : data.tenantId || tenantId
                                };
                                
                                if (!blueprintData.tenantId) {
                                    showToast('Cannot create blueprint: tenant ID is required', 'error');
                                    return;
                                }
                                
                                const result = EnhancedMockDB.createBlueprint(blueprintData);
                                if (result) {
                                    closeModal();
                                    showToast('Blueprint created successfully');
                                    setDb(EnhancedMockDB.load());
                                } else {
                                    showToast('Failed to create blueprint', 'error');
                                }
                            },
                            onCancel: closeModal,
                            userRole: userRole,
                            tenants: db.tenants
                        })
                    ]);
                };
                
                const handleEditBlueprint = (blueprint) => {
                    setEditingBlueprint(blueprint);
                    setModalContent([
                        e('div', { className: 'admin-section-header' }, [
                            e('h2', { className: 'admin-section-title' }, 'Edit Blueprint'),
                            e('button', { onClick: closeModal, style: { background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer' } }, 'Ã—')
                        ]),
                        e(BlueprintForm, {
                            key: 'form',
                            blueprint: blueprint,
                            onSave: (data) => {
                                EnhancedMockDB.updateBlueprint(blueprint.id, data);
                                closeModal();
                                showToast('Blueprint updated successfully');
                                setDb(EnhancedMockDB.load());
                            },
                            onCancel: closeModal,
                            userRole: userRole,
                            tenants: db.tenants
                        })
                    ]);
                };
                
                const handleHealthCheck = async (blueprintId) => {
                    const results = await withLoading(() => 
                        EnhancedMockDB.runBlueprintHealthCheck(blueprintId)
                    );
                    setHealthCheckResults(prev => ({ ...prev, [blueprintId]: results }));
                    
                    // Update blueprint with health check results
                    EnhancedMockDB.updateBlueprint(blueprintId, {
                        healthCheck: {
                            lastCheck: new Date().toISOString(),
                            ...results
                        }
                    });
                    setDb(EnhancedMockDB.load());
                };
                
                const handlePublish = (blueprintId) => {
                    EnhancedMockDB.publishBlueprint(blueprintId);
                    showToast('Blueprint published');
                    setDb(EnhancedMockDB.load());
                };
                
                const handleArchive = (blueprintId) => {
                    if (window.confirm('Archive this blueprint? Distributors will no longer see it.')) {
                        EnhancedMockDB.archiveBlueprint(blueprintId);
                        showToast('Blueprint archived');
                        setDb(EnhancedMockDB.load());
                    }
                };
                
                const handlePreview = (blueprint) => {
                    setModalContent([
                        e('div', { className: 'admin-section-header' }, [
                            e('h2', { className: 'admin-section-title' }, `Preview: ${blueprint.title}`),
                            e('button', { onClick: closeModal, style: { background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer' } }, 'Ã—')
                        ]),
                        e('div', { style: { padding: '24px 0' } }, [
                            e('div', { 
                                key: 'creative',
                                style: { 
                                    height: '300px',
                                    background: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
                                    borderRadius: '8px',
                                    marginBottom: '24px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: 'white',
                                    fontSize: '16px'
                                }
                            }, 'Creative Preview'),
                            e('h3', { style: { marginBottom: '12px' } }, blueprint.headline),
                            e('p', { style: { marginBottom: '12px', color: 'var(--text-secondary)' } }, blueprint.body),
                            e('button', {
                                style: {
                                    background: 'var(--brand)',
                                    color: 'white',
                                    border: 'none',
                                    padding: '12px 24px',
                                    borderRadius: '8px',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }
                            }, blueprint.cta)
                        ])
                    ]);
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('div', { key: 'title' }, [
                            e('h1', { className: 'admin-section-title' }, 'Campaign Blueprints'),
                            e('p', { className: 'admin-section-subtitle' }, 'Create and manage pre-approved campaigns for distributors' )
                        ]),
                        e('button', {
                            key: 'create',
                            className: 'admin-btn admin-btn-primary',
                            onClick: handleCreateBlueprint
                        }, 'Create Blueprint')
                    ]),
                    
                    e('div', { key: 'table', className: 'admin-section' }, [
                        e('table', { className: 'admin-table' }, [
                            e('thead', { key: 'head' }, [
                                e('tr', { key: 'row' }, [
                                    e('th', { key: 'title' }, 'Title'),
                                    e('th', { key: 'status' }, 'Status'),
                                    e('th', { key: 'health' }, 'Health'),
                                    e('th', { key: 'activations' }, 'Activations'),
                                    e('th', { key: 'actions' }, 'Actions')
                                ])
                            ]),
                            e('tbody', { key: 'body' },
                                visibleBlueprints.map(blueprint => {
                                    const activations = db.activations.filter(a => a.blueprintId === blueprint.id).length;
                                    const health = healthCheckResults[blueprint.id] || blueprint.healthCheck;
                                    
                                    return e('tr', { key: blueprint.id }, [
                                        e('td', { key: 'title' }, 
                                            e('div', null, [
                                                e('div', { style: { fontWeight: '600' } }, blueprint.title),
                                                e('div', { className: 'text-secondary', style: { fontSize: '12px' } }, 
                                                    `v${blueprint.version} â€¢ ${blueprint.objective} â€¢ Tenant: ${blueprint.tenantId}`
                                                )
                                            ])
                                        ),
                                        e('td', { key: 'status' },
                                            e('span', {
                                                className: `admin-badge ${
                                                    blueprint.status === 'published' ? 'badge-success' :
                                                    blueprint.status === 'draft' ? 'badge-warning' :
                                                    'badge-neutral'
                                                }`
                                            }, blueprint.status.toUpperCase())
                                        ),
                                        e('td', { key: 'health' },
                                            health ? e('div', null, [
                                                e('div', { 
                                                    style: { 
                                                        display: 'inline-block',
                                                        width: '12px',
                                                        height: '12px',
                                                        borderRadius: '50%',
                                                        background: health.compliance === 'pass' ? 'var(--success)' : 'var(--warning)',
                                                        marginRight: '8px'
                                                    } 
                                                }),
                                                e('span', null, `${health.clarity}%`)
                                            ]) : 'Not checked'
                                        ),
                                        e('td', { key: 'activations' }, activations),
                                        e('td', { key: 'actions' },
                                            e('div', { className: 'admin-actions' }, [
                                                e('button', {
                                                    className: 'admin-btn admin-btn-secondary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handlePreview(blueprint)
                                                }, 'Preview'),
                                                e('button', {
                                                    className: 'admin-btn admin-btn-secondary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handleHealthCheck(blueprint.id)
                                                }, 'Health Check'),
                                                e('button', {
                                                    className: 'admin-btn admin-btn-secondary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handleEditBlueprint(blueprint)
                                                }, 'Edit'),
                                                blueprint.status !== 'published' && 
                                                e('button', {
                                                    className: 'admin-btn admin-btn-primary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handlePublish(blueprint.id)
                                                }, 'Publish'),
                                                blueprint.status === 'published' &&
                                                e('button', {
                                                    className: 'admin-btn admin-btn-secondary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handleArchive(blueprint.id)
                                                }, 'Archive')
                                            ])
                                        )
                                    ]);
                                })
                            )
                        ])
                    ])
                ]);
            };
            
            // Blueprint Form Component
            const BlueprintForm = ({ blueprint, onSave, onCancel, userRole, tenants }) => {
                const [formData, setFormData] = React.useState(blueprint || {
                    title: '',
                    description: '',
                    objective: 'lead_gen',
                    channels: ['meta'],
                    dailyMin: 10,
                    dailyMax: 500,
                    durationMin: 7,
                    durationMax: 30,
                    presets: [
                        { id: 'conservative', daily: 25, duration: 14 },
                        { id: 'balanced', daily: 50, duration: 21 },
                        { id: 'aggressive', daily: 100, duration: 30 }
                    ],
                    headline: '',
                    body: '',
                    cta: 'Learn More',
                    targeting: '',
                    destination: '',
                    utm: '?utm_source=honeii&utm_medium=cpc&utm_campaign=',
                    requiresApproval: false,
                    tenantId: userRole === 'company_admin' ? (currentUser?.tenantId || '') : ''
                });
                
                const handleSubmit = (e) => {
                    e.preventDefault();
                    // FIX PACK 1: Validate tenantId
                    if (!formData.tenantId) {
                        showToast('Tenant ID is required', 'error');
                        return;
                    }
                    onSave(formData);
                };
                
                return e('form', { onSubmit: handleSubmit }, [
                    e('div', { key: 'basic', className: 'admin-form-group' }, [
                        e('label', { className: 'admin-form-label' }, 'Title'),
                        e('input', {
                            type: 'text',
                            className: 'admin-form-input',
                            value: formData.title,
                            onChange: (e) => setFormData({...formData, title: e.target.value}),
                            required: true
                        })
                    ]),
                    
                    userRole === 'honeii_admin' && e('div', { key: 'tenant', className: 'admin-form-group' }, [
                        e('label', { className: 'admin-form-label' }, 'Tenant'),
                        e('select', {
                            className: 'admin-form-input',
                            value: formData.tenantId,
                            onChange: (e) => setFormData({...formData, tenantId: e.target.value}),
                            required: true
                        }, [
                            e('option', { key: '', value: '' }, 'Select Tenant'),
                            ...tenants.map(tenant => 
                                e('option', { key: tenant.id, value: tenant.id }, tenant.name)
                            )
                        ])
                    ]),
                    
                    e('div', { key: 'channels', className: 'admin-form-group' }, [
                        e('label', { className: 'admin-form-label' }, 'Channels'),
                        e('div', { className: 'flex gap-4' }, [
                            e('label', { style: { display: 'flex', alignItems: 'center', gap: '8px' } }, [
                                e('input', {
                                    type: 'checkbox',
                                    checked: formData.channels.includes('meta'),
                                    onChange: (e) => {
                                        const channels = e.target.checked 
                                            ? [...formData.channels, 'meta']
                                            : formData.channels.filter(c => c !== 'meta');
                                        setFormData({...formData, channels});
                                    }
                                }),
                                'Meta Ads'
                            ]),
                            e('label', { style: { display: 'flex', alignItems: 'center', gap: '8px' } }, [
                                e('input', {
                                    type: 'checkbox',
                                    checked: formData.channels.includes('google'),
                                    onChange: (e) => {
                                        const channels = e.target.checked 
                                            ? [...formData.channels, 'google']
                                            : formData.channels.filter(c => c !== 'google');
                                        setFormData({...formData, channels});
                                    }
                                }),
                                'Google Ads'
                            ])
                        ])
                    ]),
                    
                    e('div', { key: 'budget', className: 'flex gap-4' }, [
                        e('div', { className: 'admin-form-group', style: { flex: 1 } }, [
                            e('label', { className: 'admin-form-label' }, 'Daily Min ($)'),
                            e('input', {
                                type: 'number',
                                className: 'admin-form-input',
                                value: formData.dailyMin,
                                onChange: (e) => setFormData({...formData, dailyMin: parseInt(e.target.value)}),
                                min: 1,
                                required: true
                            })
                        ]),
                        e('div', { className: 'admin-form-group', style: { flex: 1 } }, [
                            e('label', { className: 'admin-form-label' }, 'Daily Max ($)'),
                            e('input', {
                                type: 'number',
                                className: 'admin-form-input',
                                value: formData.dailyMax,
                                onChange: (e) => setFormData({...formData, dailyMax: parseInt(e.target.value)}),
                                min: formData.dailyMin,
                                required: true
                            })
                        ])
                    ]),
                    
                    e('div', { key: 'presets', className: 'admin-form-group' }, [
                        e('label', { className: 'admin-form-label' }, 'Presets'),
                        e('div', { className: 'flex gap-4' },
                            formData.presets.map((preset, index) => 
                                e('div', { key: preset.id, className: 'admin-form-group', style: { flex: 1 } }, [
                                    e('div', { className: 'admin-form-label' }, preset.id.toUpperCase()),
                                    e('input', {
                                        type: 'number',
                                        className: 'admin-form-input',
                                        placeholder: 'Daily',
                                        value: preset.daily,
                                        onChange: (e) => {
                                            const newPresets = [...formData.presets];
                                            newPresets[index].daily = parseInt(e.target.value);
                                            setFormData({...formData, presets: newPresets});
                                        },
                                        style: { marginBottom: '8px' }
                                    }),
                                    e('input', {
                                        type: 'number',
                                        className: 'admin-form-input',
                                        placeholder: 'Duration',
                                        value: preset.duration,
                                        onChange: (e) => {
                                            const newPresets = [...formData.presets];
                                            newPresets[index].duration = parseInt(e.target.value);
                                            setFormData({...formData, presets: newPresets});
                                        }
                                    })
                                ])
                            )
                        )
                    ]),
                    
                    e('div', { key: 'actions', className: 'flex justify-end gap-4 mt-8' }, [
                        e('button', {
                            type: 'button',
                            className: 'admin-btn admin-btn-secondary',
                            onClick: onCancel
                        }, 'Cancel'),
                        e('button', {
                            type: 'submit',
                            className: 'admin-btn admin-btn-primary'
                        }, blueprint ? 'Update Blueprint' : 'Create Blueprint')
                    ])
                ]);
            };
            
            // 3. PAYMENT CONTROL CENTER
            const PaymentControlCenter = () => {
                const filteredActivations = db.activations.filter(a => 
                    userRole === 'honeii_admin' ? true : a.tenantId === currentUser?.tenantId
                );
                
                // FIX PACK 1: Use per-tenant payment settings
                const tenantId = currentUser?.tenantId;
                const [paymentSettings, setPaymentSettings] = React.useState(() => {
                    return tenantId ? EnhancedMockDB.getPaymentSettings(tenantId) : {};
                });
                
                const [selectedRefund, setSelectedRefund] = React.useState(null);
                
                const pendingActivations = filteredActivations.filter(a => 
                    a.status === PAYMENT_CONTRACT.STATUSES.PENDING_CARD
                );
                
                const handleSettingChange = (key, value) => {
                    if (!tenantId) {
                        showToast('Cannot update settings: missing tenant', 'error');
                        return;
                    }
                    
                    const newSettings = { ...paymentSettings, [key]: value };
                    setPaymentSettings(newSettings);
                    EnhancedMockDB.setPaymentSettings(tenantId, newSettings);
                    showToast('Payment settings updated');
                    setDb(EnhancedMockDB.load());
                };
                
                const handleCapture = (activationId) => {
                    const result = EnhancedMockDB.captureCardPayment(activationId);
                    if (result) {
                        showToast('Payment captured successfully');
                        setDb(EnhancedMockDB.load());
                    }
                };
                
                const handleFail = (activationId) => {
                    const reason = prompt('Enter failure reason:');
                    if (reason) {
                        const result = EnhancedMockDB.failCardPayment(activationId, reason);
                        if (result) {
                            showToast('Payment marked as failed');
                            setDb(EnhancedMockDB.load());
                        }
                    }
                };
                
                const handleRefund = (activation) => {
                    setSelectedRefund(activation);
                    setModalContent([
                        e('div', { className: 'admin-section-header' }, [
                            e('h2', { className: 'admin-section-title' }, 'Issue Refund'),
                            e('button', { onClick: closeModal, style: { background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer' } }, 'Ã—')
                        ]),
                        e('div', { style: { padding: '24px 0' } }, [
                            e('div', { className: 'admin-form-group' }, [
                                e('label', { className: 'admin-form-label' }, 'Refund Amount'),
                                e('input', {
                                    type: 'number',
                                    className: 'admin-form-input',
                                    defaultValue: activation.totalCost,
                                    max: activation.totalCost,
                                    min: 1
                                })
                            ]),
                            e('div', { className: 'admin-form-group' }, [
                                e('label', { className: 'admin-form-label' }, 'Destination'),
                                e('select', {
                                    className: 'admin-form-input',
                                    defaultValue: paymentSettings.defaultCardRefund || 'gift_card'
                                }, PAYMENT_CONTRACT.RULES.REFUND_DESTINATIONS.map(dest => 
                                    e('option', { key: dest, value: dest }, dest.replace('_', ' ').toUpperCase())
                                ))
                            ]),
                            e('div', { className: 'admin-form-group' }, [
                                e('label', { className: 'admin-form-label' }, 'Reason'),
                                e('input', {
                                    type: 'text',
                                    className: 'admin-form-input',
                                    placeholder: 'Enter refund reason...'
                                })
                            ]),
                            e('div', { className: 'flex justify-end gap-4' }, [
                                e('button', {
                                    className: 'admin-btn admin-btn-secondary',
                                    onClick: closeModal
                                }, 'Cancel'),
                                e('button', {
                                    className: 'admin-btn admin-btn-primary',
                                    onClick: () => {
                                        // In real implementation, would collect form data
                                        showToast('Refund issued successfully');
                                        closeModal();
                                    }
                                }, 'Issue Refund')
                            ])
                        ])
                    ]);
                };
                
                const handleFreezeUser = (userId, freeze) => {
                    EnhancedMockDB.updateUser(userId, { paymentFrozen: freeze });
                    showToast(`Payments ${freeze ? 'frozen' : 'unfrozen'} for user`);
                    setDb(EnhancedMockDB.load());
                };
                
                const filteredUsers = db.users.filter(u => 
                    userRole === 'honeii_admin' ? true : u.tenantId === currentUser?.tenantId
                );
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'Payment Control Center'),
                        e('p', { className: 'admin-section-subtitle' }, 'Manage payment rules, verification, and refunds' )
                    ]),
                    
                    e('div', { key: 'settings', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '24px' } }, 'Payment Settings'),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Card Delayed Launch'),
                                    e('div', { className: 'text-secondary' }, 'Cards require verification before campaigns go live' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: paymentSettings.cardDelayedLaunch,
                                        onChange: (e) => handleSettingChange('cardDelayedLaunch', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        paymentSettings.cardDelayedLaunch && e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Verification Delay (seconds)'),
                            e('input', {
                                type: 'range',
                                className: 'admin-form-input',
                                min: '5',
                                max: '30',
                                value: paymentSettings.cardDelaySeconds || 10,
                                onChange: (e) => handleSettingChange('cardDelaySeconds', parseInt(e.target.value))
                            }),
                            e('div', { className: 'text-secondary' }, `${paymentSettings.cardDelaySeconds || 10} seconds` )
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Enable Card Payments'),
                                    e('div', { className: 'text-secondary' }, 'Allow card payments for campaigns' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: paymentSettings.cardPaymentsEnabled,
                                        onChange: (e) => handleSettingChange('cardPaymentsEnabled', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600', color: 'var(--error)' } }, 'Dispute Auto-Kill'),
                                    e('div', { className: 'text-secondary' }, 'Automatically kill campaigns when disputes are opened' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: paymentSettings.killSwitchOnDispute,
                                        onChange: (e) => handleSettingChange('killSwitchOnDispute', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Default Card Refund Destination'),
                            e('select', {
                                className: 'admin-form-input',
                                value: paymentSettings.defaultCardRefund || 'gift_card',
                                onChange: (e) => handleSettingChange('defaultCardRefund', e.target.value)
                            }, PAYMENT_CONTRACT.RULES.REFUND_DESTINATIONS.map(dest => 
                                e('option', { key: dest, value: dest }, dest.replace('_', ' ').toUpperCase())
                            ))
                        ])
                    ]),
                    
                    pendingActivations.length > 0 && e('div', { key: 'pending', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '24px' } }, 'Pending Card Launches'),
                        
                        e('table', { className: 'admin-table' }, [
                            e('thead', { key: 'head' }, [
                                e('tr', { key: 'row' }, [
                                    e('th', { key: 'campaign' }, 'Campaign'),
                                    e('th', { key: 'amount' }, 'Amount'),
                                    e('th', { key: 'user' }, 'User'),
                                    e('th', { key: 'created' }, 'Created'),
                                    e('th', { key: 'actions' }, 'Actions')
                                ])
                            ]),
                            e('tbody', { key: 'body' },
                                pendingActivations.map(activation => 
                                    e('tr', { key: activation.id }, [
                                        e('td', { key: 'campaign' }, activation.blueprintTitle),
                                        e('td', { key: 'amount' }, `$${activation.totalCost}`),
                                        e('td', { key: 'user' }, 
                                            filteredUsers.find(u => u.id === activation.userId)?.name || 'Unknown'
                                        ),
                                        e('td', { key: 'created' }, 
                                            new Date(activation.createdAt).toLocaleDateString()
                                        ),
                                        e('td', { key: 'actions' },
                                            e('div', { className: 'admin-actions' }, [
                                                e('button', {
                                                    className: 'admin-btn admin-btn-primary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handleCapture(activation.id)
                                                }, 'Capture'),
                                                e('button', {
                                                    className: 'admin-btn admin-btn-secondary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handleFail(activation.id)
                                                }, 'Fail'),
                                                e('button', {
                                                    className: 'admin-btn admin-btn-secondary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handleRefund(activation)
                                                }, 'Refund')
                                            ])
                                        )
                                    ])
                                )
                            )
                        ])
                    ]),
                    
                    e('div', { key: 'risk', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '24px' } }, 'User Risk Controls'),
                        
                        e('table', { className: 'admin-table' }, [
                            e('thead', { key: 'head' }, [
                                e('tr', { key: 'row' }, [
                                    e('th', { key: 'user' }, 'User'),
                                    e('th', { key: 'risk' }, 'Risk Level'),
                                    e('th', { key: 'status' }, 'Payment Status'),
                                    e('th', { key: 'actions' }, 'Actions')
                                ])
                            ]),
                            e('tbody', { key: 'body' },
                                filteredUsers.filter(u => u.role === 'distributor' || u.role === 'company_admin').map(user => 
                                    e('tr', { key: user.id }, [
                                        e('td', { key: 'user' }, 
                                            e('div', null, [
                                                e('div', { style: { fontWeight: '600' } }, user.name),
                                                e('div', { className: 'text-secondary', style: { fontSize: '12px' } }, user.email)
                                            ])
                                        ),
                                        e('td', { key: 'risk' },
                                            e('span', {
                                                className: `admin-badge ${
                                                    user.riskLevel === 'high' ? 'badge-error' :
                                                    user.riskLevel === 'medium' ? 'badge-warning' :
                                                    'badge-success'
                                                }`
                                            }, user.riskLevel.toUpperCase())
                                        ),
                                        e('td', { key: 'status' },
                                            e('span', {
                                                className: `admin-badge ${
                                                    user.paymentFrozen ? 'badge-error' : 'badge-success'
                                                }`
                                            }, user.paymentFrozen ? 'FROZEN' : 'ACTIVE')
                                        ),
                                        e('td', { key: 'actions' },
                                            e('button', {
                                                className: `admin-btn ${user.paymentFrozen ? 'admin-btn-primary' : 'admin-btn-error'}`,
                                                style: { fontSize: '12px', padding: '6px 12px' },
                                                onClick: () => handleFreezeUser(user.id, !user.paymentFrozen)
                                            }, user.paymentFrozen ? 'Unfreeze' : 'Freeze')
                                        )
                                    ])
                                )
                            )
                        ])
                    ])
                ]);
            };
            
            // 4. DISPUTE MANAGER - FIXED
            const DisputeManager = () => {
                // CRITICAL FIX: Safe array guard and tenant filtering
                const dbDisputes = Array.isArray(db.disputes) ? db.disputes : [];
                const tenantId = currentUser?.tenantId;
                
                // Tenant isolation guard
                if (userRole === 'company_admin' && !tenantId) {
                    return e('div', { className: 'admin-panel' }, [
                        e('div', { className: 'admin-section' }, [
                            e('h1', { className: 'admin-section-title' }, 'Configuration Error'),
                            e('p', { className: 'admin-section-subtitle' }, 
                                'Your account is missing tenant configuration. Please contact support.'
                            )
                        ])
                    ]);
                }
                
                // Tenant-scoped filtering with safe fallback
                const tenantScopedDisputes = dbDisputes.filter(d => {
                    if (userRole === 'honeii_admin') return true;
                    return d.tenantId === tenantId;
                });
                
                const [filter, setFilter] = React.useState('all');
                
                // Apply status filter to tenant-scoped disputes
                const visibleDisputes = tenantScopedDisputes.filter(dispute => {
                    if (filter === 'all') return true;
                    return dispute.status === filter;
                });
                
                const handleCreateDispute = () => {
                    setModalContent([
                        e('div', { className: 'admin-section-header' }, [
                            e('h2', { className: 'admin-section-title' }, 'Create Dispute'),
                            e('button', { onClick: closeModal, style: { background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer' } }, 'Ã—')
                        ]),
                        e('div', { style: { padding: '24px 0' } }, [
                            e('div', { className: 'admin-form-group' }, [
                                e('label', { className: 'admin-form-label' }, 'Select Activation'),
                                e('select', { className: 'admin-form-input' },
                                    db.activations
                                        .filter(a => a.paymentMethod === PAYMENT_CONTRACT.METHODS.CARD)
                                        .filter(a => userRole === 'honeii_admin' ? true : a.tenantId === tenantId)
                                        .map(act => 
                                            e('option', { key: act.id, value: act.id }, `${act.blueprintTitle} - $${act.totalCost}`)
                                        )
                                )
                            ]),
                            e('div', { className: 'admin-form-group' }, [
                                e('label', { className: 'admin-form-label' }, 'Reason'),
                                e('select', { className: 'admin-form-input' }, [
                                    e('option', { value: 'fraud' }, 'Fraud'),
                                    e('option', { value: 'chargeback' }, 'Chargeback'),
                                    e('option', { value: 'unauthorized' }, 'Unauthorized'),
                                    e('option', { value: 'service_issue' }, 'Service Issue')
                                ])
                            ]),
                            e('div', { className: 'flex justify-end gap-4' }, [
                                e('button', {
                                    className: 'admin-btn admin-btn-secondary',
                                    onClick: closeModal
                                }, 'Cancel'),
                                e('button', {
                                    className: 'admin-btn admin-btn-primary',
                                    onClick: () => {
                                        // In real implementation, would collect form data
                                        showToast('Dispute created with auto-kill');
                                        closeModal();
                                    }
                                }, 'Create Dispute')
                            ])
                        ])
                    ]);
                };
                
                const handleResolveDispute = (disputeId, status) => {
                    EnhancedMockDB.resolveDispute(disputeId, { status });
                    showToast(`Dispute marked as ${status}`);
                    setDb(EnhancedMockDB.load());
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('div', { key: 'title' }, [
                            e('h1', { className: 'admin-section-title' }, 'Dispute Manager'),
                            e('p', { className: 'admin-section-subtitle' }, 'Review and resolve payment disputes' )
                        ]),
                        e('button', {
                            key: 'create',
                            className: 'admin-btn admin-btn-primary',
                            onClick: handleCreateDispute
                        }, 'Create Dispute')
                    ]),
                    
                    e('div', { key: 'filters', className: 'flex gap-4 mb-4' }, [
                        e('button', {
                            className: `admin-btn ${filter === 'all' ? 'admin-btn-primary' : 'admin-btn-secondary'}`,
                            onClick: () => setFilter('all')
                        }, 'All'),
                        e('button', {
                            className: `admin-btn ${filter === 'open' ? 'admin-btn-primary' : 'admin-btn-secondary'}`,
                            onClick: () => setFilter('open')
                        }, 'Open'),
                        e('button', {
                            className: `admin-btn ${filter === 'under_review' ? 'admin-btn-primary' : 'admin-btn-secondary'}`,
                            onClick: () => setFilter('under_review')
                        }, 'Under Review'),
                        e('button', {
                            className: `admin-btn ${filter === 'resolved' ? 'admin-btn-primary' : 'admin-btn-secondary'}`,
                            onClick: () => setFilter('resolved')
                        }, 'Resolved')
                    ]),
                    
                    e('div', { key: 'table', className: 'admin-section' }, [
                        visibleDisputes.length === 0 ? 
                            e('div', { style: { textAlign: 'center', padding: '48px', color: 'var(--text-secondary)' } }, 
                                'No disputes found' ) :
                            e('table', { className: 'admin-table' }, [
                                e('thead', { key: 'head' }, [
                                    e('tr', { key: 'row' }, [
                                        e('th', { key: 'id' }, 'Dispute ID'),
                                        e('th', { key: 'activation' }, 'Activation'),
                                        e('th', { key: 'user' }, 'User'),
                                        e('th', { key: 'status' }, 'Status'),
                                        e('th', { key: 'opened' }, 'Opened'),
                                        e('th', { key: 'actions' }, 'Actions')
                                    ])
                                ]),
                                e('tbody', { key: 'body' },
                                    visibleDisputes.map(dispute => {
                                        const activation = db.activations.find(a => a.id === dispute.activationId);
                                        const user = db.users.find(u => u.id === dispute.userId);
                                        
                                        return e('tr', { key: dispute.id }, [
                                            e('td', { key: 'id' }, 
                                                e('code', { style: { fontSize: '12px' } }, dispute.id.substring(0, 8))
                                            ),
                                            e('td', { key: 'activation' }, activation?.blueprintTitle || 'Unknown'),
                                            e('td', { key: 'user' }, user?.name || 'Unknown'),
                                            e('td', { key: 'status' },
                                                e('span', {
                                                    className: `admin-badge ${
                                                        dispute.status === 'open' ? 'badge-warning' :
                                                        dispute.status === 'under_review' ? 'badge-info' :
                                                        'badge-neutral'
                                                    }`
                                                }, dispute.status.replace('_', ' ').toUpperCase())
                                            ),
                                            e('td', { key: 'opened' }, 
                                                new Date(dispute.openedAt).toLocaleDateString()
                                            ),
                                            e('td', { key: 'actions' },
                                                dispute.status === 'open' && e('div', { className: 'admin-actions' }, [
                                                    e('button', {
                                                        className: 'admin-btn admin-btn-secondary',
                                                        style: { fontSize: '12px', padding: '6px 12px' },
                                                        onClick: () => handleResolveDispute(dispute.id, 'under_review')
                                                    }, 'Review'),
                                                    e('button', {
                                                        className: 'admin-btn admin-btn-primary',
                                                        style: { fontSize: '12px', padding: '6px 12px' },
                                                        onClick: () => handleResolveDispute(dispute.id, 'resolved')
                                                    }, 'Resolve')
                                                ])
                                            )
                                        ]);
                                    })
                                )
                            ])
                    ])
                ]);
            };
            
            // 5. USERS & PERMISSIONS
            const UsersPermissions = () => {
                const filteredUsers = db.users.filter(u => 
                    userRole === 'honeii_admin' ? true : u.tenantId === currentUser?.tenantId
                );
                const [selectedUser, setSelectedUser] = React.useState(null);
                
                const handleAdjustBalance = (userId) => {
                    const amount = parseFloat(prompt('Enter amount to add (negative to deduct):'));
                    if (!isNaN(amount)) {
                        const reason = prompt('Reason for adjustment:');
                        EnhancedMockDB.adjustWalletBalance(userId, amount, reason);
                        showToast(`Balance adjusted by $${amount}`);
                        setDb(EnhancedMockDB.load());
                    }
                };
                
                const handleViewActivations = (userId) => {
                    const userActivations = db.activations.filter(a => a.userId === userId);
                    setModalContent([
                        e('div', { className: 'admin-section-header' }, [
                            e('h2', { className: 'admin-section-title' }, 'User Activations'),
                            e('button', { onClick: closeModal, style: { background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer' } }, 'Ã—')
                        ]),
                        e('div', { style: { padding: '24px 0' } },
                            userActivations.length === 0 ? 
                                e('p', { style: { color: 'var(--text-secondary)' } }, 'No activations found' ) :
                                e('table', { className: 'admin-table' }, [
                                    e('thead', { key: 'head' }, [
                                        e('tr', { key: 'row' }, [
                                            e('th', { key: 'campaign' }, 'Campaign'),
                                            e('th', { key: 'status' }, 'Status'),
                                            e('th', { key: 'amount' }, 'Amount'),
                                            e('th', { key: 'created' }, 'Created')
                                        ])
                                    ]),
                                    e('tbody', { key: 'body' },
                                        userActivations.map(act => 
                                            e('tr', { key: act.id }, [
                                                e('td', { key: 'campaign' }, act.blueprintTitle),
                                                e('td', { key: 'status' },
                                                    e('span', {
                                                        className: `admin-badge ${
                                                            act.status === 'launched' ? 'badge-success' :
                                                            act.status === 'pending_card' ? 'badge-warning' :
                                                            'badge-neutral'
                                                        }`
                                                    }, act.status.replace('_', ' ').toUpperCase())
                                                ),
                                                e('td', { key: 'amount' }, `$${act.totalCost}`),
                                                e('td', { key: 'created' }, 
                                                    new Date(act.createdAt).toLocaleDateString()
                                                )
                                            ])
                                        )
                                    )
                                ])
                        )
                    ]);
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'Users & Permissions'),
                        e('p', { className: 'admin-section-subtitle' }, 'Manage user accounts and permissions' )
                    ]),
                    
                    e('div', { key: 'table', className: 'admin-section' }, [
                        e('table', { className: 'admin-table' }, [
                            e('thead', { key: 'head' }, [
                                e('tr', { key: 'row' }, [
                                    e('th', { key: 'user' }, 'User'),
                                    e('th', { key: 'role' }, 'Role'),
                                    e('th', { key: 'balance' }, 'Wallet Balance'),
                                    e('th', { key: 'status' }, 'Status'),
                                    e('th', { key: 'actions' }, 'Actions')
                                ])
                            ]),
                            e('tbody', { key: 'body' },
                                filteredUsers.map(user => 
                                    e('tr', { key: user.id }, [
                                        e('td', { key: 'user' }, 
                                            e('div', null, [
                                                e('div', { style: { fontWeight: '600' } }, user.name),
                                                e('div', { className: 'text-secondary', style: { fontSize: '12px' } }, user.email)
                                            ])
                                        ),
                                        e('td', { key: 'role' },
                                            e('span', {
                                                className: `admin-badge ${
                                                    user.role === 'honeii_admin' ? 'badge-info' :
                                                    user.role === 'company_admin' ? 'badge-warning' :
                                                    'badge-success'
                                                }`
                                            }, user.role.replace('_', ' ').toUpperCase())
                                        ),
                                        e('td', { key: 'balance' }, `$${user.walletBalance}`),
                                        e('td', { key: 'status' },
                                            e('span', {
                                                className: `admin-badge ${
                                                    user.paymentFrozen ? 'badge-error' : 'badge-success'
                                                }`
                                            }, user.paymentFrozen ? 'FROZEN' : 'ACTIVE')
                                        ),
                                        e('td', { key: 'actions' },
                                            e('div', { className: 'admin-actions' }, [
                                                e('button', {
                                                    className: 'admin-btn admin-btn-secondary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handleAdjustBalance(user.id)
                                                }, 'Adjust Balance'),
                                                e('button', {
                                                    className: 'admin-btn admin-btn-secondary',
                                                    style: { fontSize: '12px', padding: '6px 12px' },
                                                    onClick: () => handleViewActivations(user.id)
                                                }, 'View Activations')
                                            ])
                                        )
                                    ])
                                )
                            )
                        ])
                    ])
                ]);
            };
            
            // 6. DISCOUNTS & FAST START SETTINGS
            const DiscountsSettings = () => {
                // FIX PACK 1: Use per-tenant discount settings
                const tenantId = currentUser?.tenantId;
                const [discountSettings, setDiscountSettings] = React.useState(() => {
                    return tenantId ? EnhancedMockDB.getDiscountSettings(tenantId) : {};
                });
                
                const handleSettingChange = (key, value) => {
                    if (!tenantId) {
                        showToast('Cannot update settings: missing tenant', 'error');
                        return;
                    }
                    
                    const newSettings = { ...discountSettings, [key]: value };
                    setDiscountSettings(newSettings);
                    EnhancedMockDB.setDiscountSettings(tenantId, newSettings);
                    showToast('Discount settings updated');
                    setDb(EnhancedMockDB.load());
                };
                
                const handleUpdateDiscount = (index, value) => {
                    const newOptions = [...discountSettings.options];
                    newOptions[index].value = parseFloat(value);
                    handleSettingChange('options', newOptions);
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'Discounts & Fast Start'),
                        e('p', { className: 'admin-section-subtitle' }, 'Configure distributor discount options' )
                    ]),
                    
                    e('div', { key: 'settings', className: 'admin-section' }, [
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Enable Distributor Discounts'),
                                    e('div', { className: 'text-secondary' }, 'Allow distributors to offer discounts to customers' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: discountSettings.enabled,
                                        onChange: (e) => handleSettingChange('enabled', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        discountSettings.enabled && e('div', null, [
                            e('h3', { style: { margin: '24px 0 16px' } }, 'Discount Options'),
                            
                            e('div', { className: 'flex gap-4' },
                                discountSettings.options.map((option, index) => 
                                    e('div', { key: option.id, className: 'admin-form-group', style: { flex: 1 } }, [
                                        e('label', { className: 'admin-form-label' }, option.label),
                                        e('input', {
                                            type: 'number',
                                            className: 'admin-form-input',
                                            value: option.value,
                                            onChange: (e) => handleUpdateDiscount(index, e.target.value),
                                            min: 0,
                                            max: 100,
                                            step: 0.5
                                        })
                                    ])
                                )
                            ),
                            
                            e('div', { className: 'admin-form-group', style: { marginTop: '24px' } }, [
                                e('label', { className: 'admin-form-label' }, 'Fast Start Split Ratio'),
                                e('input', {
                                    type: 'range',
                                    className: 'admin-form-input',
                                    min: '0',
                                    max: '100',
                                    value: (discountSettings.fastStartSplit || 0.5) * 100,
                                    onChange: (e) => handleSettingChange('fastStartSplit', parseInt(e.target.value) / 100)
                                }),
                                e('div', { className: 'text-secondary' }, 
                                    `${Math.round((discountSettings.fastStartSplit || 0.5) * 100)}% goes to distributor, ${Math.round((1 - (discountSettings.fastStartSplit || 0.5)) * 100)}% goes to customer discount`
                                )
                            ]),
                            
                            e('div', { className: 'admin-form-group', style: { 
                                background: 'var(--surface-secondary)',
                                padding: '16px',
                                borderRadius: '8px',
                                marginTop: '24px'
                            } }, [
                                e('h4', { style: { marginBottom: '8px' } }, 'How It Works'),
                                e('p', { className: 'text-secondary' }, 
                                    'When a distributor applies a discount, half of the Fast Start commission goes to the distributor and half becomes a customer discount. This encourages distributors to offer discounts while maintaining their earnings.'
                                )
                            ])
                        ])
                    ])
                ]);
            };
            
            // 7. MAIL BUCKETS
            const MailBuckets = () => {
                const filteredBuckets = db.mailBuckets.filter(b => 
                    userRole === 'honeii_admin' ? true : b.tenantId === currentUser?.tenantId
                );
                const [selectedBucket, setSelectedBucket] = React.useState(null);
                const [campaignContent, setCampaignContent] = React.useState({ subject: '', body: '' });
                
                const handleCreateBucket = () => {
                    const name = prompt('Enter bucket name:');
                    if (name) {
                        const description = prompt('Enter description:');
                        
                        // FIX PACK 1: Enforce tenantId
                        if (userRole === 'company_admin' && !currentUser?.tenantId) {
                            showToast('Cannot create bucket: missing tenant configuration', 'error');
                            return;
                        }
                        
                        EnhancedMockDB.createMailBucket({ 
                            name, 
                            description, 
                            tags: [], 
                            tenantId: currentUser?.tenantId 
                        });
                        showToast('Mail bucket created');
                        setDb(EnhancedMockDB.load());
                    }
                };
                
                const handleGenerateContent = async () => {
                    const content = await withLoading(() => EnhancedMockDB.generateEmailContent());
                    setCampaignContent(content);
                };
                
                const handleSendCampaign = async (bucketId) => {
                    const results = await withLoading(() => EnhancedMockDB.sendMailCampaign(bucketId, campaignContent));
                    if (results) {
                        showToast(`Campaign sent to ${results.sent} contacts`);
                        setDb(EnhancedMockDB.load());
                    }
                };
                
                const handleSelectBucket = (bucket) => {
                    setSelectedBucket(bucket);
                    setModalContent([
                        e('div', { className: 'admin-section-header' }, [
                            e('h2', { className: 'admin-section-title' }, `Bucket: ${bucket.name}`),
                            e('button', { onClick: closeModal, style: { background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer' } }, 'Ã—')
                        ]),
                        e('div', { style: { padding: '24px 0' } }, [
                            e('div', { className: 'admin-form-group' }, [
                                e('label', { className: 'admin-form-label' }, 'Subject'),
                                e('input', {
                                    type: 'text',
                                    className: 'admin-form-input',
                                    value: campaignContent.subject,
                                    onChange: (e) => setCampaignContent(prev => ({ ...prev, subject: e.target.value })),
                                    placeholder: 'Email subject...'
                                })
                            ]),
                            e('div', { className: 'admin-form-group' }, [
                                e('label', { className: 'admin-form-label' }, 'Body'),
                                e('textarea', {
                                    className: 'admin-form-input',
                                    rows: 6,
                                    value: campaignContent.body,
                                    onChange: (e) => setCampaignContent(prev => ({ ...prev, body: e.target.value })),
                                    placeholder: 'Email body...'
                                })
                            ]),
                            e('div', { className: 'flex justify-between gap-4' }, [
                                e('button', {
                                    className: 'admin-btn admin-btn-secondary',
                                    onClick: handleGenerateContent
                                }, 'AI Generate'),
                                e('button', {
                                    className: 'admin-btn admin-btn-primary',
                                    onClick: () => handleSendCampaign(bucket.id)
                                }, `Send to ${bucket.contacts} Contacts`
                                )
                            ])
                        ])
                    ]);
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('div', { key: 'title' }, [
                            e('h1', { className: 'admin-section-title' }, 'Mail Buckets'),
                            e('p', { className: 'admin-section-subtitle' }, 'Manage email lists and campaigns' )
                        ]),
                        e('button', {
                            key: 'create',
                            className: 'admin-btn admin-btn-primary',
                            onClick: handleCreateBucket
                        }, 'Create Bucket')
                    ]),
                    
                    e('div', { key: 'buckets', className: 'admin-section' }, [
                        e('div', { className: 'grid', style: { gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '16px' } },
                            filteredBuckets.map(bucket => 
                                e('div', { 
                                    key: bucket.id,
                                    className: 'blueprint-card',
                                    onClick: () => handleSelectBucket(bucket)
                                }, [
                                    e('div', { className: 'blueprint-content' }, [
                                        e('h3', { className: 'blueprint-title' }, bucket.name),
                                        e('p', { className: 'text-secondary', style: { marginBottom: '16px' } }, 
                                            bucket.description || 'No description'
                                        ),
                                        e('div', { className: 'flex justify-between text-secondary' }, [
                                            e('div', null, `Contacts: ${bucket.contacts}`),
                                            e('div', null, `Sent: ${bucket.sent}`)
                                        ]),
                                        e('div', { className: 'flex justify-between text-secondary', style: { marginTop: '8px' } }, [
                                            e('div', null, `Delivered: ${bucket.delivered}`),
                                            e('div', null, `Opened: ${bucket.opened}`)
                                        ])
                                    ])
                                ])
                            )
                        )
                    ])
                ]);
            };
            
            // 8. SETTINGS
            const Settings = () => {
                const currentTenantSettings = db.tenantSettings.find(ts => 
                    userRole === 'honeii_admin' ? true : ts.tenantId === currentUser?.tenantId
                ) || db.tenantSettings[0];
                
                const [tenantSettings, setTenantSettings] = React.useState(currentTenantSettings);
                
                const handleSettingChange = (path, value) => {
                    const keys = path.split('.');
                    const newSettings = { ...tenantSettings };
                    let current = newSettings;
                    
                    for (let i = 0; i < keys.length - 1; i++) {
                        current = current[keys[i]];
                    }
                    
                    current[keys[keys.length - 1]] = value;
                    setTenantSettings(newSettings);
                    
                    // Update in database
                    const updatedSettings = db.tenantSettings.map(ts => 
                        ts.tenantId === tenantSettings.tenantId ? newSettings : ts
                    );
                    updateDb({ tenantSettings: updatedSettings });
                    
                    showToast('Settings updated');
                };
                
                const handleColorChange = (color) => {
                    handleSettingChange('primaryColor', color);
                    document.documentElement.style.setProperty('--brand', color);
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'Settings'),
                        e('p', { className: 'admin-section-subtitle' }, 'Configure tenant branding and features' )
                    ]),
                    
                    e('div', { key: 'branding', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '24px' } }, 'Branding'),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Company Name'),
                            e('input', {
                                type: 'text',
                                className: 'admin-form-input',
                                value: tenantSettings.brandName,
                                onChange: (e) => handleSettingChange('brandName', e.target.value)
                            })
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Primary Color'),
                            e('input', {
                                type: 'color',
                                className: 'admin-form-input',
                                value: tenantSettings.primaryColor,
                                onChange: (e) => handleColorChange(e.target.value),
                                style: { height: '40px', width: '100%' }
                            })
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Enable Honeycomb Background'),
                                    e('div', { className: 'text-secondary' }, 'Show honeycomb pattern in background' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: tenantSettings.honeycombBackground,
                                        onChange: (e) => handleSettingChange('honeycombBackground', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ])
                    ]),
                    
                    e('div', { key: 'features', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '24px' } }, 'Feature Flags'),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Google Ads Channel'),
                                    e('div', { className: 'text-secondary' }, 'Enable Google Ads campaigns' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: tenantSettings.featureFlags.googleChannel,
                                        onChange: (e) => handleSettingChange('featureFlags.googleChannel', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Mail Buckets'),
                                    e('div', { className: 'text-secondary' }, 'Enable email marketing features' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: tenantSettings.featureFlags.mailBuckets,
                                        onChange: (e) => handleSettingChange('featureFlags.mailBuckets', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600' } }, 'Distributor Discounts'),
                                    e('div', { className: 'text-secondary' }, 'Allow distributors to offer discounts' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: tenantSettings.featureFlags.discounts,
                                        onChange: (e) => handleSettingChange('featureFlags.discounts', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ]),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('div', { className: 'flex justify-between items-center' }, [
                                e('div', null, [
                                    e('div', { style: { fontWeight: '600', color: 'var(--error)' } }, 'Dispute Auto-Freeze'),
                                    e('div', { className: 'text-secondary' }, 'Automatically freeze user payments on disputes' )
                                ]),
                                e('label', { className: 'admin-toggle' }, [
                                    e('input', {
                                        type: 'checkbox',
                                        checked: tenantSettings.featureFlags.disputeAutoFreeze,
                                        onChange: (e) => handleSettingChange('featureFlags.disputeAutoFreeze', e.target.checked)
                                    }),
                                    e('span', { className: 'admin-toggle-slider' })
                                ])
                            ])
                        ])
                    ])
                ]);
            };
            
            // DISTRIBUTOR VIEWS
            const CampaignHub = () => {
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'Campaign Hub'),
                        e('p', { className: 'admin-section-subtitle' }, 'Launch and manage your campaigns' )
                    ]),
                    
                    e('div', { key: 'welcome', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '16px' } }, `Welcome, ${currentUser?.name}`),
                        e('div', { className: 'flex gap-8' }, [
                            e('div', { key: 'wallet', className: 'admin-form-group', style: { flex: 1 } }, [
                                e('div', { className: 'admin-form-label' }, 'Wallet Balance'),
                                e('div', { className: 'kpi-value' }, `$${currentUser?.walletBalance || 0}`),
                                e('button', {
                                    className: 'admin-btn admin-btn-primary mt-4',
                                    onClick: () => setCurrentView('wallet')
                                }, 'Manage Wallet')
                            ]),
                            e('div', { key: 'status', className: 'admin-form-group', style: { flex: 1 } }, [
                                e('div', { className: 'admin-form-label' }, 'Payment Status'),
                                e('div', { style: { marginTop: '8px' } },
                                    currentUser?.paymentFrozen ? 
                                        e('span', { className: 'admin-badge badge-error' }, 'PAYMENTS FROZEN' ) :
                                        e('span', { className: 'admin-badge badge-success' }, 'ACTIVE' )
                                ),
                                e('div', { className: 'text-secondary mt-4' }, 
                                    currentUser?.paymentFrozen ? 
                                        'Your payments are frozen due to a dispute. Contact support.' :
                                        'Your account is in good standing.'
                                )
                            ])
                        ])
                    ]),
                    
                    e('div', { key: 'blueprints', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '16px' } }, 'Available Campaign Blueprints'),
                        e('div', { className: 'grid', style: { gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '16px' } },
                            db.blueprints
                                .filter(bp => bp.status === 'published')
                                .filter(bp => userRole === 'distributor' ? bp.tenantId === currentUser?.tenantId : true)
                                .map(bp => 
                                    e('div', { key: bp.id, className: 'blueprint-card' }, [
                                        e('div', { 
                                            key: 'creative',
                                            style: { 
                                                height: '150px',
                                                background: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: 'white',
                                                fontSize: '16px'
                                            }
                                        }, 'Campaign Preview'),
                                        e('div', { className: 'blueprint-content' }, [
                                            e('h3', { className: 'blueprint-title' }, bp.title),
                                            e('p', { className: 'text-secondary', style: { marginBottom: '16px' } }, bp.description),
                                            e('div', { className: 'flex justify-between text-secondary', style: { fontSize: '12px', marginBottom: '16px' } }, [
                                                e('div', null, `$${bp.dailyMin}-${bp.dailyMax}/day`),
                                                e('div', null, `${bp.durationMin}-${bp.durationMax} days`)
                                            ]),
                                            e('button', {
                                                className: 'admin-btn admin-btn-primary w-full',
                                                onClick: () => {
                                                    // In real implementation, would launch activation
                                                    showToast('Campaign launch would proceed to payment');
                                                }
                                            }, 'Launch Campaign')
                                        ])
                                    ])
                                )
                        )
                    ])
                ]);
            };
            
            const Wallet = () => {
                const [amount, setAmount] = React.useState(100);
                
                const handleAddFunds = () => {
                    EnhancedMockDB.adjustWalletBalance(currentUser.id, amount, 'Manual deposit');
                    showToast(`Added $${amount} to wallet`);
                    setDb(EnhancedMockDB.load());
                };
                
                const handleCreateActivation = () => {
                    // In real implementation, would create activation
                    showToast('Activation created - choose payment method');
                };
                
                return e('div', { className: 'admin-panel' }, [
                    e('div', { key: 'header', className: 'admin-section-header' }, [
                        e('h1', { className: 'admin-section-title' }, 'Wallet'),
                        e('p', { className: 'admin-section-subtitle' }, 'Manage your funds and transactions' )
                    ]),
                    
                    e('div', { key: 'balance', className: 'admin-section' }, [
                        e('div', { className: 'text-center' }, [
                            e('div', { className: 'text-secondary' }, 'Current Balance'),
                            e('div', { 
                                className: 'kpi-value',
                                style: { fontSize: '48px', margin: '16px 0' }
                            }, `$${currentUser?.walletBalance || 0}`),
                            e('div', { className: 'text-secondary' }, 
                                currentUser?.paymentFrozen ? 
                                    'âš ï¸ Payments are currently frozen' :
                                    'Account is active'
                            )
                        ])
                    ]),
                    
                    e('div', { key: 'addFunds', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '16px' } }, 'Add Funds'),
                        
                        e('div', { className: 'admin-form-group' }, [
                            e('label', { className: 'admin-form-label' }, 'Amount'),
                            e('div', { className: 'flex gap-4' }, [
                                e('input', {
                                    type: 'range',
                                    className: 'admin-form-input',
                                    min: '10',
                                    max: '1000',
                                    step: '10',
                                    value: amount,
                                    onChange: (e) => setAmount(parseInt(e.target.value))
                                }),
                                e('div', { 
                                    style: { 
                                        minWidth: '80px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '20px',
                                        fontWeight: '600'
                                    }
                                }, `$${amount}`)
                            ])
                        ]),
                        
                        e('div', { className: 'flex gap-4' }, [
                            e('button', {
                                className: 'admin-btn admin-btn-secondary',
                                onClick: () => setAmount(100)
                            }, '$100'),
                            e('button', {
                                className: 'admin-btn admin-btn-secondary',
                                onClick: () => setAmount(250)
                            }, '$250'),
                            e('button', {
                                className: 'admin-btn admin-btn-secondary',
                                onClick: () => setAmount(500)
                            }, '$500')
                        ]),
                        
                        e('button', {
                            className: 'admin-btn admin-btn-primary w-full mt-8',
                            onClick: handleAddFunds,
                            disabled: currentUser?.paymentFrozen
                        }, currentUser?.paymentFrozen ? 'Payments Frozen' : 'Add Funds to Wallet')
                    ]),
                    
                    e('div', { key: 'transactions', className: 'admin-section' }, [
                        e('h2', { style: { marginBottom: '16px' } }, 'Recent Transactions'),
                        e('div', { style: { textAlign: 'center', padding: '48px', color: 'var(--text-secondary)' } }, 
                            'No recent transactions' )
                    ])
                ]);
            };
            
            // Main App Render
            const renderView = () => {
                // Honeii Admin Views
                if (userRole === 'honeii_admin') {
                    switch(currentView) {
                        case 'tenant-manager': return e(TenantManager, { key: 'tenant-manager' });
                        case 'tenant-payments': return e(TenantPaymentSettings, { key: 'tenant-payments' });
                        case 'tenant-discounts': return e(TenantDiscountSettings, { key: 'tenant-discounts' });
                        case 'system-ledger': return e(SystemLedger, { key: 'system-ledger' });
                        case 'system-audit': return e('div', { className: 'admin-panel' }, [
                            e('div', { className: 'admin-section' }, [
                                e('h1', { className: 'admin-section-title' }, 'Audit Log'),
                                e('p', { className: 'admin-section-subtitle' }, 'View system audit trail' )
                            ])
                        ]);
                        default: return e(TenantManager, { key: 'tenant-manager' });
                    }
                }
                // Company Admin Views
                else if (userRole === 'company_admin') {
                    switch(currentView) {
                        case 'admin-dashboard': return e(AdminDashboard, { key: 'admin-dashboard' });
                        case 'blueprints': return e(BlueprintsManager, { key: 'blueprints' });
                        case 'payment-control': return e(PaymentControlCenter, { key: 'payment-control' });
                        case 'dispute-manager': return e(DisputeManager, { key: 'dispute-manager' });
                        case 'users-permissions': return e(UsersPermissions, { key: 'users-permissions' });
                        case 'discounts-settings': return e(DiscountsSettings, { key: 'discounts-settings' });
                        case 'mail-buckets': return e(MailBuckets, { key: 'mail-buckets' });
                        case 'settings': return e(Settings, { key: 'settings' });
                        default: return e(AdminDashboard, { key: 'admin-dashboard' });
                    }
                }
                // Distributor Views
                else if (userRole === 'distributor') {
                    switch(currentView) {
                        case 'campaign-hub': return e(CampaignHub, { key: 'campaign-hub' });
                        case 'my-campaigns': return e('div', { className: 'admin-panel' }, [
                            e('div', { className: 'admin-section' }, [
                                e('h1', { className: 'admin-section-title' }, 'My Campaigns'),
                                e('p', { className: 'admin-section-subtitle' }, 'View your active campaigns' )
                            ])
                        ]);
                        case 'wallet': return e(Wallet, { key: 'wallet' });
                        case 'distributor-ledger': return e('div', { className: 'admin-panel' }, [
                            e('div', { className: 'admin-section' }, [
                                e('h1', { className: 'admin-section-title' }, 'Transaction History'),
                                e('p', { className: 'admin-section-subtitle' }, 'View your transaction history' )
                            ])
                        ]);
                        default: return e(CampaignHub, { key: 'campaign-hub' });
                    }
                }
                
                return e(AdminDashboard, { key: 'default' });
            };
            
            const renderSidebar = () => {
                if (userRole === 'honeii_admin') {
                    return e(HoneiiAdminSidebar, { key: 'sidebar' });
                } else if (userRole === 'company_admin') {
                    return e(CompanyAdminSidebar, { key: 'sidebar' });
                } else {
                    return e(DistributorSidebar, { key: 'sidebar' });
                }
            };
            
            return e('div', { className: 'app-container' }, [
                e(Header, { key: 'header' }),
                renderSidebar(),
                e('div', { key: 'main', className: 'main-content' }, renderView()),
                e(Toast, { key: 'toast' }),
                e(Modal, { key: 'modal' }),
                e(LoadingOverlay, { key: 'loading' })
            ]);
        };

        // ==========================================================
        // MOUNT THE APPLICATION
        // ==========================================================
        ReactDOM.render(
            e(ErrorBoundary, null, e(App, null)),
            document.getElementById('root')
        );
    </script>
</body>
</html>